<!doctype html>
<html lang="id" class="scroll-smooth">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Kegiatan Sekolah - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        /* Custom animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Auto-sync pulse animation */
        .pulse-green {
            animation: pulseGreen 2s infinite;
        }
        
        .pulse-blue {
            animation: pulseBlue 1.5s infinite;
        }
        
        @keyframes pulseGreen {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }
        
        @keyframes pulseBlue {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.2);
            }
        }
        
        /* Sidebar active state */
        .sidebar-item.active {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border-left: 4px solid #fbbf24;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .sidebar-item {
            transition: all 0.3s ease;
        }
        
        .sidebar-item:hover {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            transform: translateX(2px);
        }
        
        /* Gradient backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #f59e0b 100%);
        }
        
        .gradient-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        /* Button hover effects */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            transition: all 0.3s ease;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
        }
        
        /* Card hover effects */
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
        }
        
        /* Status indicators */
        .status-online {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .status-offline {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        /* Form styling */
        .form-input {
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        /* Print styles for documents */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-page {
                page-break-after: always;
            }
            
            body {
                font-size: 12pt;
                line-height: 1.4;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 20px;
                border-bottom: 2px solid #000;
                padding-bottom: 10px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-100"><!-- Mobile Menu Button --> <button id="mobile-menu-btn" class="md:hidden fixed top-4 left-4 z-50 bg-white p-2 rounded-lg shadow-lg"> <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i> </button>
  <div class="flex min-h-screen"><!-- Sidebar -->
   <aside id="sidebar" class="sidebar fixed md:relative w-64 bg-white shadow-lg z-40 md:z-auto">
    <div class="gradient-bg p-6 text-white">
     <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center"><i data-lucide="school" class="w-6 h-6 text-white"></i>
      </div>
      <div>
       <h1 class="text-xl font-bold">Sistem Sekolah</h1>
       <p class="text-sm opacity-90">Kegiatan &amp; Agenda</p>
      </div>
     </div>
    </div>
    <nav class="p-4">
     <ul class="space-y-2">
      <li><a href="#dashboard-section" id="menu-dashboard" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer active"> <i data-lucide="layout-dashboard" class="w-5 h-5"></i> <span class="font-medium">Dashboard</span> </a></li>
      <li><a href="#agenda-section" id="menu-agenda" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer"> <i data-lucide="calendar" class="w-5 h-5"></i> <span class="font-medium">Agenda Kegiatan</span> </a></li>
      <li><a href="#rekap-section" id="menu-rekap" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer"> <i data-lucide="bar-chart-3" class="w-5 h-5"></i> <span class="font-medium">Rekap Kegiatan</span> </a></li>
      <li><a href="#daftar-hadir-section" id="menu-daftar-hadir" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer"> <i data-lucide="users" class="w-5 h-5"></i> <span class="font-medium">Daftar Hadir</span> </a></li>
      <li><a href="#berita-acara-section" id="menu-berita-acara" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer"> <i data-lucide="file-text" class="w-5 h-5"></i> <span class="font-medium">Berita Acara</span> </a></li>
      <li><a href="#pengaturan-section" id="menu-pengaturan" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg cursor-pointer"> <i data-lucide="settings" class="w-5 h-5"></i> <span class="font-medium">Pengaturan</span> </a></li>
     </ul>
    </nav><!-- User Profile -->
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t">
     <div class="flex items-center space-x-3">
      <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-amber-500 rounded-full flex items-center justify-center"><i data-lucide="user" class="w-5 h-5 text-white"></i>
      </div>
      <div>
       <p class="font-medium text-gray-800">Admin Sekolah</p>
       <p class="text-sm text-gray-500">Administrator</p>
      </div>
     </div>
    </div>
   </aside><!-- Main Content -->
   <main class="flex-1 md:ml-0 ml-0"><!-- Header -->
    <header class="bg-white shadow-sm border-b p-4 md:p-6">
     <div class="flex items-center justify-between">
      <div>
       <h2 id="page-title" class="text-2xl font-bold text-gray-800">Dashboard</h2>
       <p id="page-subtitle" class="text-gray-600">Selamat datang di sistem kegiatan sekolah</p>
      </div>
      <div class="flex items-center space-x-4">
       <div class="flex items-center space-x-2">
        <div id="connection-status" class="w-3 h-3 status-online rounded-full"></div><span class="text-sm text-gray-600">Online</span>
       </div>
       <div class="flex items-center space-x-2">
        <div id="auto-sync-indicator" class="w-3 h-3 bg-green-500 rounded-full pulse-green"></div><span id="auto-sync-text" class="text-sm text-green-600 font-medium">Auto-sync</span> <button id="toggle-auto-sync" onclick="toggleAutoSync()" class="text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition-colors"> ON </button>
       </div><button onclick="refreshData()" class="btn-primary text-white px-4 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="refresh-cw" class="w-4 h-4 inline mr-2"></i> Refresh </button>
      </div>
     </div>
    </header><!-- Dashboard Section -->
    <section id="dashboard-section" class="section p-4 md:p-6 fade-in">
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><!-- Stats Cards -->
      <div class="gradient-card p-6 rounded-xl shadow-lg card-hover transition-all duration-300">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-600 text-sm font-medium">Total Kegiatan</p>
         <p id="total-kegiatan" class="text-3xl font-bold text-gray-800">0</p>
        </div>
        <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center"><i data-lucide="calendar-days" class="w-6 h-6 text-white"></i>
        </div>
       </div>
      </div>
      <div class="gradient-card p-6 rounded-xl shadow-lg card-hover transition-all duration-300">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-600 text-sm font-medium">Kegiatan Hari Ini</p>
         <p id="kegiatan-hari-ini" class="text-3xl font-bold text-gray-800">0</p>
        </div>
        <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center"><i data-lucide="clock" class="w-6 h-6 text-white"></i>
        </div>
       </div>
      </div>
      <div class="gradient-card p-6 rounded-xl shadow-lg card-hover transition-all duration-300">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-600 text-sm font-medium">Peserta Aktif</p>
         <p id="peserta-aktif" class="text-3xl font-bold text-gray-800">0</p>
        </div>
        <div class="w-12 h-12 bg-purple-500 rounded-lg flex items-center justify-center"><i data-lucide="users" class="w-6 h-6 text-white"></i>
        </div>
       </div>
      </div>
      <div class="gradient-card p-6 rounded-xl shadow-lg card-hover transition-all duration-300">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-600 text-sm font-medium">Tingkat Kehadiran</p>
         <p id="tingkat-kehadiran" class="text-3xl font-bold text-gray-800">0%</p>
        </div>
        <div class="w-12 h-12 bg-amber-500 rounded-lg flex items-center justify-center"><i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
        </div>
       </div>
      </div>
     </div><!-- Recent Activities -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Kegiatan Terbaru</h3>
      <div class="space-y-4" id="recent-activities-container"><!-- Akan diisi oleh JavaScript -->
       <div class="text-center py-8"><i data-lucide="calendar-x" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
        <p class="text-gray-500 mb-2">Belum ada kegiatan</p>
        <p class="text-sm text-gray-400">Tambah kegiatan baru atau muat data dari Google Sheets</p>
       </div>
      </div>
     </div>
    </section><!-- Agenda Section -->
    <section id="agenda-section" class="section p-4 md:p-6 hidden">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Agenda Kegiatan</h3><button onclick="tambahKegiatan()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i> Tambah Kegiatan </button>
      </div><!-- Form Tambah Kegiatan -->
      <div id="form-kegiatan" class="hidden bg-gray-50 p-6 rounded-lg mb-6">
       <h4 class="text-lg font-semibold text-gray-800 mb-4">Form Kegiatan Baru</h4>
       <form onsubmit="simpanKegiatan(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Nama Kegiatan</label> <input type="text" id="nama-kegiatan" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Masukkan nama kegiatan" required>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Jenis Kegiatan</label> <select id="jenis-kegiatan" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required onchange="updateKategoriOptions()"> <option value="">Pilih Jenis Kegiatan</option> <option value="Akademik">Akademik</option> <option value="Non-Akademik">Non-Akademik</option> <option value="Kesiswaan">Kesiswaan</option> <option value="Manajemen">Sekolah dan Manajemen</option> <option value="Lingkungan">Lingkungan dan Sosial</option> <option value="Khusus">Akhir Tahun / Khusus</option> </select>
        </div>
        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Kategori Kegiatan</label> <select id="kategori-kegiatan" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required> <option value="">Pilih Jenis Kegiatan terlebih dahulu</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Mulai</label> <input type="date" id="tanggal-mulai" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Selesai</label> <input type="date" id="tanggal-selesai" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Waktu Mulai</label> <input type="time" id="waktu-mulai" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Waktu Selesai</label> <input type="time" id="waktu-selesai" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Status</label> <select id="status-kegiatan" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required> <option value="Terjadwal">Terjadwal</option> <option value="Berlangsung">Berlangsung</option> <option value="Selesai">Selesai</option> <option value="Dibatalkan">Dibatalkan</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Penanggung Jawab</label> <input type="text" id="penanggung-jawab" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Nama penanggung jawab" required>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Peserta</label> <input type="number" id="jumlah-peserta" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="0" min="0" max="1000" required>
        </div>
        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi</label> <textarea id="deskripsi-kegiatan" rows="3" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none" placeholder="Deskripsi kegiatan"></textarea>
        </div>
        <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">Upload Dokumentasi (Opsional)</label> <input type="file" id="dokumentasi" accept="image/*" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
         <p class="text-sm text-gray-500 mt-1">Format: JPG, PNG, maksimal 5MB</p>
        </div>
        <div class="md:col-span-2 flex space-x-4"><button type="submit" class="btn-success text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="save" class="w-4 h-4 inline mr-2"></i> Simpan Kegiatan </button> <button type="button" onclick="batalTambah()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-all duration-300 hover:shadow-lg active:scale-95"> <i data-lucide="x" class="w-4 h-4 inline mr-2"></i> Batal </button>
        </div>
       </form>
      </div><!-- Daftar Kegiatan -->
      <div class="space-y-4" id="agenda-list-container"><!-- Akan diisi oleh JavaScript -->
       <div class="text-center py-12"><i data-lucide="calendar-plus" class="w-20 h-20 text-gray-300 mx-auto mb-4"></i>
        <h4 class="text-lg font-semibold text-gray-600 mb-2">Belum Ada Kegiatan</h4>
        <p class="text-gray-500 mb-4">Mulai dengan menambah kegiatan baru atau muat data dari Google Sheets</p>
        <div class="flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4"><button onclick="tambahKegiatan()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i> Tambah Kegiatan </button> <button onclick="bacaDataDariGoogleSheets()" class="btn-success text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="download" class="w-4 h-4 inline mr-2"></i> Muat dari Google Sheets </button>
        </div>
       </div>
      </div>
     </div>
    </section><!-- Rekap Section -->
    <section id="rekap-section" class="section p-4 md:p-6 hidden">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Rekap Kegiatan</h3>
       <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2"><button onclick="exportData()" class="btn-success text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="download" class="w-4 h-4 inline mr-2"></i> Export Data </button> <button onclick="generateReport()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i> Generate Report </button>
       </div>
      </div><!-- Filter -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Periode</label> <select class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none"> <option>Bulan Ini</option> <option>3 Bulan Terakhir</option> <option>6 Bulan Terakhir</option> <option>Tahun Ini</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Status</label> <select class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none"> <option>Semua Status</option> <option>Selesai</option> <option>Berlangsung</option> <option>Dibatalkan</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label> <select class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none"> <option>Semua Kategori</option> <option>Seminar</option> <option>Workshop</option> <option>Lomba</option> <option>Pelatihan</option> </select>
       </div>
      </div><!-- Statistics -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
       <div class="bg-blue-50 p-6 rounded-lg">
        <h4 class="text-lg font-semibold text-blue-800 mb-2">Total Kegiatan</h4>
        <p id="rekap-total-kegiatan" class="text-3xl font-bold text-blue-600">0</p>
        <p class="text-sm text-blue-600">Data dari Google Sheets</p>
       </div>
       <div class="bg-green-50 p-6 rounded-lg">
        <h4 class="text-lg font-semibold text-green-800 mb-2">Kegiatan Selesai</h4>
        <p id="rekap-kegiatan-selesai" class="text-3xl font-bold text-green-600">0</p>
        <p id="rekap-persentase-selesai" class="text-sm text-green-600">0% tingkat penyelesaian</p>
       </div>
       <div class="bg-purple-50 p-6 rounded-lg">
        <h4 class="text-lg font-semibold text-purple-800 mb-2">Total Peserta</h4>
        <p id="rekap-total-peserta" class="text-3xl font-bold text-purple-600">0</p>
        <p id="rekap-rata-rata-peserta" class="text-sm text-purple-600">Rata-rata 0 per kegiatan</p>
       </div>
      </div><!-- Table -->
      <div class="overflow-x-auto">
       <table class="w-full border-collapse">
        <thead>
         <tr class="bg-gray-50">
          <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-800">Nama Kegiatan</th>
          <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-800">Tanggal</th>
          <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-800">Peserta</th>
          <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-800">Status</th>
          <th class="border border-gray-200 px-4 py-3 text-left font-semibold text-gray-800">Aksi</th>
         </tr>
        </thead>
        <tbody id="rekap-table-body">
         <tr>
          <td colspan="5" class="border border-gray-200 px-4 py-8 text-center text-gray-500">Belum ada data kegiatan. Muat data dari Google Sheets terlebih dahulu.</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </section><!-- Berita Acara Section -->
    <section id="berita-acara-section" class="section p-4 md:p-6 hidden">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Berita Acara Kegiatan</h3>
       <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2"><button onclick="generateBeritaAcara()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="file-plus" class="w-4 h-4 inline mr-2"></i> Generate Berita Acara </button> <button id="simpan-berita-acara-btn" onclick="simpanBeritaAcaraLangsung()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95 hidden"> <i data-lucide="save" class="w-4 h-4 inline mr-2"></i> Simpan ke Google Sheets </button> <button onclick="downloadAllBeritaAcara()" class="btn-success text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="download" class="w-4 h-4 inline mr-2"></i> Download Semua </button>
       </div>
      </div><!-- Filter Kegiatan -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kegiatan</label> <select id="filter-kegiatan-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" onchange="filterBeritaAcara()"> <option value="">Semua Kegiatan</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Status</label> <select id="filter-status-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" onchange="filterBeritaAcara()"> <option value="">Semua Status</option> <option value="Selesai">Selesai</option> <option value="Berlangsung">Berlangsung</option> <option value="Terjadwal">Terjadwal</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Periode</label> <select id="filter-periode-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" onchange="filterBeritaAcara()"> <option value="">Semua Periode</option> <option value="hari-ini">Hari Ini</option> <option value="minggu-ini">Minggu Ini</option> <option value="bulan-ini">Bulan Ini</option> </select>
       </div>
      </div><!-- Daftar Berita Acara -->
      <div id="berita-acara-list" class="space-y-4"><!-- Akan diisi oleh JavaScript -->
       <div class="text-center py-12"><i data-lucide="file-text" class="w-20 h-20 text-gray-300 mx-auto mb-4"></i>
        <h4 class="text-lg font-semibold text-gray-600 mb-2">Belum Ada Berita Acara</h4>
        <p class="text-gray-500 mb-4">Generate berita acara otomatis dari kegiatan yang sudah ada</p><button onclick="generateBeritaAcara()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium"> <i data-lucide="file-plus" class="w-4 h-4 inline mr-2"></i> Generate Berita Acara </button>
       </div>
      </div>
     </div>
    </section><!-- Daftar Hadir Section -->
    <section id="daftar-hadir-section" class="section p-4 md:p-6 hidden">
     <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4 md:mb-0">Daftar Hadir Kegiatan</h3>
       <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2"><button onclick="generateDaftarHadir()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i> Generate Daftar Hadir </button> <button id="simpan-daftar-hadir-btn" onclick="simpanDaftarHadirLangsung()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95 hidden"> <i data-lucide="save" class="w-4 h-4 inline mr-2"></i> Simpan &amp; Kirim ke Berita Acara </button> <button onclick="downloadAllDaftarHadir()" class="btn-success text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="download" class="w-4 h-4 inline mr-2"></i> Download Semua </button>
       </div>
      </div><!-- Filter Kegiatan -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kegiatan</label> <select id="filter-kegiatan-dh" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" onchange="filterDaftarHadir()"> <option value="">Semua Kegiatan</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Format</label> <select id="format-daftar-hadir" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none"> <option value="standard">Standard (Nama, TTD)</option> <option value="lengkap">Lengkap (Nama, Jabatan, Instansi, TTD)</option> <option value="siswa">Siswa (No, Nama, Kelas, TTD)</option> <option value="guru">Guru (Nama, NIP, Mata Pelajaran, TTD)</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Baris</label> <input type="number" id="jumlah-baris-dh" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" value="30" min="10" max="100">
       </div>
      </div><!-- Daftar Template Hadir -->
      <div id="daftar-hadir-list" class="space-y-4"><!-- Akan diisi oleh JavaScript -->
       <div class="text-center py-12"><i data-lucide="users" class="w-20 h-20 text-gray-300 mx-auto mb-4"></i>
        <h4 class="text-lg font-semibold text-gray-600 mb-2">Belum Ada Template Daftar Hadir</h4>
        <p class="text-gray-500 mb-4">Generate template daftar hadir untuk kegiatan yang akan dilaksanakan</p><button onclick="generateDaftarHadir()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium"> <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i> Generate Daftar Hadir </button>
       </div>
      </div>
     </div>
    </section><!-- Pengaturan Section -->
    <section id="pengaturan-section" class="section p-4 md:p-6 hidden">
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><!-- Google Sheets Integration -->
      <div class="bg-white rounded-xl shadow-lg p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4">Google Sheets Integration</h3>
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Spreadsheet ID</label> <input type="text" id="spreadsheet-id" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Masukkan Spreadsheet ID" value="1iVQ3zjRY1cu1DWz7UFb_BmxfyYqgLukbWGaVmlML_7c" readonly>
         <p class="text-xs text-gray-500 mt-1">Sheet ID sudah dikonfigurasi</p>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Sheet Name</label> <input type="text" id="sheet-name" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Nama sheet" value="Kegiatan_Sekolah" readonly>
         <p class="text-xs text-gray-500 mt-1">Nama sheet default: Kegiatan_Sekolah</p>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Status Koneksi</label>
         <div class="flex items-center space-x-2 p-3 bg-green-50 border border-green-200 rounded-lg">
          <div class="w-3 h-3 bg-green-500 rounded-full"></div><span class="text-sm text-green-700 font-medium">Siap untuk sinkronisasi</span>
         </div>
        </div>
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4"><button onclick="testConnection()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="wifi" class="w-4 h-4 inline mr-2"></i> Test Koneksi </button> <button onclick="saveSettings()" class="btn-success text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="save" class="w-4 h-4 inline mr-2"></i> Simpan Pengaturan </button>
        </div>
       </div>
      </div><!-- Apps Script Integration -->
      <div class="bg-white rounded-xl shadow-lg p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4">Apps Script Integration</h3><!-- Panduan Setup -->
       <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
        <h4 class="font-semibold text-blue-800 mb-2">ðŸ“‹ Panduan Setup Google Sheets &amp; Apps Script:</h4>
        <ol class="text-sm text-blue-700 space-y-1">
         <li>1. Buka Google Sheets dengan ID: <code class="bg-blue-100 px-1 rounded">1iVQ3zjRY1cu1DWz7UFb_BmxfyYqgLukbWGaVmlML_7c</code></li>
         <li>2. Buat 5 sheet dengan nama: "Kegiatan_Sekolah", "Berita_Acara", "Daftar_Hadir", "Peserta_Kegiatan", "Data_Guru_Staff"</li>
         <li>3. Buka Extensions â†’ Apps Script</li>
         <li>4. Hapus kode default, paste kode lengkap di bawah</li>
         <li>5. Save project (Ctrl+S) dan beri nama "Sistem Kegiatan Sekolah"</li>
         <li>6. Deploy â†’ New Deployment â†’ Web App</li>
         <li>7. Execute as: Me, Access: Anyone</li>
         <li>8. Copy URL deployment ke field Script URL</li>
         <li>9. Buat folder "Kegiatan Sekolah" di Google Drive untuk foto</li>
         <li>10. Test fungsi dengan menu "Sistem Kegiatan Sekolah" di spreadsheet</li>
        </ol>
       </div><!-- Google Apps Script Code -->
       <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
        <h4 class="font-semibold text-gray-800 mb-2">ðŸ“„ Kode Google Apps Script Lengkap:</h4>
        <div class="bg-gray-900 text-green-400 p-4 rounded text-xs overflow-x-auto max-h-64">
         <pre><code>// ===== SISTEM KEGIATAN SEKOLAH - GOOGLE APPS SCRIPT =====
// Paste kode ini ke Google Apps Script Editor
// Version: 2.0 - Complete Auto Headers &amp; Tables

// Konfigurasi Spreadsheet
const SPREADSHEET_ID = '1iVQ3zjRY1cu1DWz7UFb_BmxfyYqgLukbWGaVmlML_7c';
const SHEETS = {
  KEGIATAN: 'Kegiatan_Sekolah',
  BERITA_ACARA: 'Berita_Acara', 
  DAFTAR_HADIR: 'Daftar_Hadir',
  PESERTA: 'Peserta_Kegiatan',
  DATA_GURU: 'Data_Guru_Staff'
};

// Headers untuk setiap sheet
const SHEET_HEADERS = {
  [SHEETS.KEGIATAN]: [
    'ID', 'Nama Kegiatan', 'Jenis', 'Kategori', 'Tanggal Mulai', 
    'Tanggal Selesai', 'Waktu Mulai', 'Waktu Selesai', 'Status', 
    'Penanggung Jawab', 'Jumlah Peserta', 'Deskripsi', 'Dokumentasi', 
    'Created At', 'Updated At'
  ],
  [SHEETS.BERITA_ACARA]: [
    'ID', 'Kegiatan ID', 'Nama Kegiatan', 'Tempat', 'Pimpinan Rapat', 
    'Agenda', 'Hasil Keputusan', 'Notulen', 'Moderator', 'Catatan', 
    'Daftar Hadir ID', 'Jumlah Peserta', 'Status', 'Created At'
  ],
  [SHEETS.DAFTAR_HADIR]: [
    'ID', 'Kegiatan ID', 'Nama Kegiatan', 'Format', 'Jumlah Baris', 
    'Orientasi', 'Ukuran Font', 'Catatan', 'Jumlah Peserta', 
    'Status', 'Created At'
  ],
  [SHEETS.PESERTA]: [
    'ID', 'Daftar Hadir ID', 'Kegiatan ID', 'No Urut', 'Nama', 
    'Jabatan', 'Instansi', 'NIP', 'Mata Pelajaran', 'Kelas', 
    'Created At'
  ],
  [SHEETS.DATA_GURU]: [
    'ID', 'Nama Lengkap', 'NIP', 'Jabatan', 'Mata Pelajaran', 
    'Kelas Diampu', 'Email', 'No Telepon', 'Alamat', 'Status', 
    'Created At', 'Updated At'
  ]
};

// Main function untuk handle HTTP requests
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    console.log('Received data:', data);
    
    switch(data.action) {
      case 'CREATE':
      case 'CREATE_KEGIATAN':
        return handleCreateKegiatan(data.data);
      case 'CREATE_BERITA_ACARA':
        return handleCreateBeritaAcara(data.data);
      case 'CREATE_DAFTAR_HADIR':
        return handleCreateDaftarHadir(data.data);
      case 'CREATE_PESERTA':
        return handleCreatePeserta(data.data);
      case 'CREATE_DATA_GURU':
        return handleCreateDataGuru(data.data);
      default:
        return createResponse(false, 'Unknown action: ' + data.action);
    }
  } catch (error) {
    console.error('Error in doPost:', error);
    return createResponse(false, 'Server error: ' + error.message);
  }
}

function doGet(e) {
  try {
    const action = e.parameter.action || 'read_kegiatan';
    
    switch(action) {
      case 'read':
      case 'read_kegiatan':
        return handleReadKegiatan();
      case 'read_berita_acara':
        return handleReadBeritaAcara();
      case 'read_daftar_hadir':
        return handleReadDaftarHadir();
      case 'read_peserta':
        return handleReadPeserta();
      case 'read_data_guru':
        return handleReadDataGuru();
      default:
        return createResponse(false, 'Unknown GET action: ' + action);
    }
  } catch (error) {
    console.error('Error in doGet:', error);
    return createResponse(false, 'Server error: ' + error.message);
  }
}

// ===== KEGIATAN FUNCTIONS =====
function handleCreateKegiatan(data) {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.KEGIATAN);
    
    // Add data
    const row = [
      data.id || '',
      data.nama_kegiatan || '',
      data.jenis_kegiatan || '',
      data.kategori_kegiatan || '',
      data.tanggal_mulai || '',
      data.tanggal_selesai || '',
      data.waktu_mulai || '',
      data.waktu_selesai || '',
      data.status || '',
      data.penanggung_jawab || '',
      data.jumlah_peserta || 0,
      data.deskripsi || '',
      data.dokumentasi || '',
      data.created_at || new Date().toISOString(),
      new Date().toISOString()
    ];
    
    sheet.appendRow(row);
    console.log('Kegiatan created successfully:', data.id);
    
    return createResponse(true, 'Kegiatan berhasil disimpan', { id: data.id });
  } catch (error) {
    console.error('Error creating kegiatan:', error);
    return createResponse(false, 'Gagal menyimpan kegiatan: ' + error.message);
  }
}

function handleReadKegiatan() {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.KEGIATAN);
    const data = sheet.getDataRange().getValues();
    
    if (data.length &lt;= 1) {
      return createResponse(true, 'No data found', []);
    }
    
    // Remove headers
    const rows = data.slice(1);
    console.log('Read kegiatan data:', rows.length, 'rows');
    
    return createResponse(true, 'Data berhasil dibaca', rows);
  } catch (error) {
    console.error('Error reading kegiatan:', error);
    return createResponse(false, 'Gagal membaca data: ' + error.message);
  }
}

// ===== BERITA ACARA FUNCTIONS =====
function handleCreateBeritaAcara(data) {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.BERITA_ACARA);
    
    // Add data
    const row = [
      data.id || '',
      data.kegiatan_id || '',
      data.nama_kegiatan || '',
      data.tempat_kegiatan || '',
      data.pimpinan_rapat || '',
      data.agenda_pembahasan || '',
      data.hasil_keputusan || '',
      data.notulen || '',
      data.moderator || '',
      data.catatan_tambahan || '',
      data.daftar_hadir_id || '',
      data.jumlah_peserta || 0,
      data.status || 'Draft',
      data.created_at || new Date().toISOString()
    ];
    
    sheet.appendRow(row);
    console.log('Berita Acara created successfully:', data.id);
    
    return createResponse(true, 'Berita Acara berhasil disimpan', { id: data.id });
  } catch (error) {
    console.error('Error creating berita acara:', error);
    return createResponse(false, 'Gagal menyimpan berita acara: ' + error.message);
  }
}

function handleReadBeritaAcara() {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.BERITA_ACARA);
    const data = sheet.getDataRange().getValues();
    
    if (data.length &lt;= 1) {
      return createResponse(true, 'No data found', []);
    }
    
    const rows = data.slice(1);
    console.log('Read berita acara data:', rows.length, 'rows');
    
    return createResponse(true, 'Data berhasil dibaca', rows);
  } catch (error) {
    console.error('Error reading berita acara:', error);
    return createResponse(false, 'Gagal membaca data: ' + error.message);
  }
}

// ===== DAFTAR HADIR FUNCTIONS =====
function handleCreateDaftarHadir(data) {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.DAFTAR_HADIR);
    
    // Add data
    const row = [
      data.id || '',
      data.kegiatan_id || '',
      data.nama_kegiatan || '',
      data.format || 'standard',
      data.jumlah_baris || 30,
      data.orientasi || 'portrait',
      data.ukuran_font || 'medium',
      data.catatan || '',
      data.jumlah_peserta || 0,
      data.status || 'Draft',
      data.created_at || new Date().toISOString()
    ];
    
    sheet.appendRow(row);
    console.log('Daftar Hadir created successfully:', data.id);
    
    // Auto-save participants if provided
    if (data.peserta_data &amp;&amp; Array.isArray(data.peserta_data)) {
      const pesertaData = data.peserta_data.map(peserta =&gt; ({
        ...peserta,
        daftar_hadir_id: data.id,
        kegiatan_id: data.kegiatan_id
      }));
      handleCreatePeserta(pesertaData);
    }
    
    return createResponse(true, 'Daftar Hadir berhasil disimpan', { id: data.id });
  } catch (error) {
    console.error('Error creating daftar hadir:', error);
    return createResponse(false, 'Gagal menyimpan daftar hadir: ' + error.message);
  }
}

function handleReadDaftarHadir() {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.DAFTAR_HADIR);
    const data = sheet.getDataRange().getValues();
    
    if (data.length &lt;= 1) {
      return createResponse(true, 'No data found', []);
    }
    
    const rows = data.slice(1);
    console.log('Read daftar hadir data:', rows.length, 'rows');
    
    return createResponse(true, 'Data berhasil dibaca', rows);
  } catch (error) {
    console.error('Error reading daftar hadir:', error);
    return createResponse(false, 'Gagal membaca data: ' + error.message);
  }
}

// ===== PESERTA FUNCTIONS =====
function handleCreatePeserta(data) {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.PESERTA);
    
    // Add data (could be array of participants)
    const participants = Array.isArray(data) ? data : [data];
    
    participants.forEach(peserta =&gt; {
      const row = [
        peserta.id || 'P' + Date.now() + Math.random().toString(36).substr(2, 5),
        peserta.daftar_hadir_id || '',
        peserta.kegiatan_id || '',
        peserta.no_urut || peserta.no || 0,
        peserta.nama || '',
        peserta.jabatan || '',
        peserta.instansi || '',
        peserta.nip || '',
        peserta.mata_pelajaran || peserta.mapel || '',
        peserta.kelas || '',
        peserta.created_at || new Date().toISOString()
      ];
      
      sheet.appendRow(row);
    });
    
    console.log('Peserta created successfully:', participants.length, 'participants');
    
    return createResponse(true, 'Data peserta berhasil disimpan', { count: participants.length });
  } catch (error) {
    console.error('Error creating peserta:', error);
    return createResponse(false, 'Gagal menyimpan data peserta: ' + error.message);
  }
}

function handleReadPeserta() {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.PESERTA);
    const data = sheet.getDataRange().getValues();
    
    if (data.length &lt;= 1) {
      return createResponse(true, 'No data found', []);
    }
    
    const rows = data.slice(1);
    console.log('Read peserta data:', rows.length, 'rows');
    
    return createResponse(true, 'Data berhasil dibaca', rows);
  } catch (error) {
    console.error('Error reading peserta:', error);
    return createResponse(false, 'Gagal membaca data: ' + error.message);
  }
}

// ===== DATA GURU FUNCTIONS =====
function handleCreateDataGuru(data) {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.DATA_GURU);
    
    // Add data
    const row = [
      data.id || 'G' + Date.now(),
      data.nama_lengkap || '',
      data.nip || '',
      data.jabatan || '',
      data.mata_pelajaran || '',
      data.kelas_diampu || '',
      data.email || '',
      data.no_telepon || '',
      data.alamat || '',
      data.status || 'Aktif',
      data.created_at || new Date().toISOString(),
      new Date().toISOString()
    ];
    
    sheet.appendRow(row);
    console.log('Data Guru created successfully:', data.id);
    
    return createResponse(true, 'Data Guru berhasil disimpan', { id: data.id });
  } catch (error) {
    console.error('Error creating data guru:', error);
    return createResponse(false, 'Gagal menyimpan data guru: ' + error.message);
  }
}

function handleReadDataGuru() {
  try {
    const sheet = getOrCreateSheetWithHeaders(SHEETS.DATA_GURU);
    const data = sheet.getDataRange().getValues();
    
    if (data.length &lt;= 1) {
      return createResponse(true, 'No data found', []);
    }
    
    const rows = data.slice(1);
    console.log('Read data guru:', rows.length, 'rows');
    
    return createResponse(true, 'Data berhasil dibaca', rows);
  } catch (error) {
    console.error('Error reading data guru:', error);
    return createResponse(false, 'Gagal membaca data: ' + error.message);
  }
}

// ===== UTILITY FUNCTIONS =====
function getOrCreateSheetWithHeaders(sheetName) {
  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = spreadsheet.getSheetByName(sheetName);
  
  if (!sheet) {
    sheet = spreadsheet.insertSheet(sheetName);
    console.log('Created new sheet:', sheetName);
  }
  
  // Setup headers if sheet is empty or doesn't have proper headers
  if (sheet.getLastRow() === 0 || !hasValidHeaders(sheet, sheetName)) {
    setupSheetHeaders(sheet, sheetName);
  }
  
  return sheet;
}

function hasValidHeaders(sheet, sheetName) {
  try {
    if (sheet.getLastRow() === 0) return false;
    
    const expectedHeaders = SHEET_HEADERS[sheetName];
    if (!expectedHeaders) return false;
    
    const actualHeaders = sheet.getRange(1, 1, 1, expectedHeaders.length).getValues()[0];
    
    // Check if headers match
    for (let i = 0; i &lt; expectedHeaders.length; i++) {
      if (actualHeaders[i] !== expectedHeaders[i]) {
        return false;
      }
    }
    
    return true;
  } catch (error) {
    console.error('Error checking headers:', error);
    return false;
  }
}

function setupSheetHeaders(sheet, sheetName) {
  try {
    const headers = SHEET_HEADERS[sheetName];
    if (!headers) {
      console.error('No headers defined for sheet:', sheetName);
      return;
    }
    
    // Clear existing content if any
    if (sheet.getLastRow() &gt; 0) {
      sheet.clear();
    }
    
    // Set headers
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // Format headers
    const headerRange = sheet.getRange(1, 1, 1, headers.length);
    headerRange.setFontWeight('bold');
    headerRange.setBackground('#f0f0f0');
    headerRange.setBorder(true, true, true, true, true, true);
    
    // Set column widths
    for (let i = 1; i &lt;= headers.length; i++) {
      sheet.setColumnWidth(i, getColumnWidth(headers[i - 1]));
    }
    
    // Freeze header row
    sheet.setFrozenRows(1);
    
    console.log('Headers setup completed for sheet:', sheetName);
  } catch (error) {
    console.error('Error setting up headers for sheet:', sheetName, error);
  }
}

function getColumnWidth(headerName) {
  const widthMap = {
    'ID': 120,
    'Nama Kegiatan': 200,
    'Nama Lengkap': 180,
    'Jenis': 120,
    'Kategori': 150,
    'Tanggal Mulai': 120,
    'Tanggal Selesai': 120,
    'Waktu Mulai': 100,
    'Waktu Selesai': 100,
    'Status': 100,
    'Penanggung Jawab': 150,
    'Jumlah Peserta': 120,
    'Deskripsi': 250,
    'Dokumentasi': 150,
    'Created At': 150,
    'Updated At': 150,
    'Kegiatan ID': 120,
    'Tempat': 150,
    'Pimpinan Rapat': 150,
    'Agenda': 200,
    'Hasil Keputusan': 200,
    'Notulen': 120,
    'Moderator': 120,
    'Catatan': 200,
    'Daftar Hadir ID': 120,
    'Format': 100,
    'Jumlah Baris': 100,
    'Orientasi': 100,
    'Ukuran Font': 100,
    'No Urut': 80,
    'Nama': 150,
    'Jabatan': 120,
    'Instansi': 150,
    'NIP': 150,
    'Mata Pelajaran': 150,
    'Kelas': 80,
    'Kelas Diampu': 120,
    'Email': 180,
    'No Telepon': 120,
    'Alamat': 200
  };
  
  return widthMap[headerName] || 120;
}

function createResponse(success, message, data = null) {
  const response = {
    success: success,
    message: message,
    timestamp: new Date().toISOString()
  };
  
  if (data !== null) {
    response.data = data;
  }
  
  return ContentService
    .createTextOutput(JSON.stringify(response))
    .setMimeType(ContentService.MimeType.JSON);
}

// ===== MENU FUNCTIONS =====
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('Sistem Kegiatan Sekolah')
    .addItem('Setup All Sheets', 'setupAllSheets')
    .addItem('Reset Headers', 'resetAllHeaders')
    .addItem('Test Connection', 'testConnection')
    .addItem('Clear All Data', 'clearAllData')
    .addItem('Generate Sample Data', 'generateSampleData')
    .addItem('Generate Template Guru', 'generateTemplateGuru')
    .addToUi();
}

function setupAllSheets() {
  try {
    let createdSheets = [];
    let updatedSheets = [];
    
    Object.values(SHEETS).forEach(sheetName =&gt; {
      const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
      let sheet = spreadsheet.getSheetByName(sheetName);
      
      if (!sheet) {
        sheet = getOrCreateSheetWithHeaders(sheetName);
        createdSheets.push(sheetName);
      } else {
        // Check and update headers if needed
        if (!hasValidHeaders(sheet, sheetName)) {
          setupSheetHeaders(sheet, sheetName);
          updatedSheets.push(sheetName);
        }
      }
    });
    
    let message = 'Setup Complete!\n\n';
    if (createdSheets.length &gt; 0) {
      message += 'Sheets Created:\n' + createdSheets.join('\n') + '\n\n';
    }
    if (updatedSheets.length &gt; 0) {
      message += 'Headers Updated:\n' + updatedSheets.join('\n') + '\n\n';
    }
    message += 'All sheets ready for use!';
    
    SpreadsheetApp.getUi().alert('Setup Complete', message, SpreadsheetApp.getUi().ButtonSet.OK);
  } catch (error) {
    SpreadsheetApp.getUi().alert('Setup Error', 'Error: ' + error.message, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function resetAllHeaders() {
  try {
    Object.values(SHEETS).forEach(sheetName =&gt; {
      const sheet = getOrCreateSheetWithHeaders(sheetName);
      setupSheetHeaders(sheet, sheetName);
    });
    
    SpreadsheetApp.getUi().alert('Headers Reset', 
      'Semua header sheet telah direset dan diformat ulang.', 
      SpreadsheetApp.getUi().ButtonSet.OK);
  } catch (error) {
    SpreadsheetApp.getUi().alert('Reset Error', 
      'Error: ' + error.message, 
      SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function testConnection() {
  try {
    const testData = {
      id: 'TEST_' + Date.now(),
      nama_kegiatan: 'Test Connection',
      jenis_kegiatan: 'Test',
      kategori_kegiatan: 'Test',
      tanggal_mulai: new Date().toISOString().split('T')[0],
      tanggal_selesai: new Date().toISOString().split('T')[0],
      waktu_mulai: '08:00',
      waktu_selesai: '10:00',
      status: 'Test',
      penanggung_jawab: 'Test User',
      jumlah_peserta: 1,
      deskripsi: 'Test koneksi sistem',
      created_at: new Date().toISOString()
    };
    
    handleCreateKegiatan(testData);
    
    SpreadsheetApp.getUi().alert('Test Berhasil', 
      'Koneksi ke Google Sheets berhasil!\nTest data telah ditambahkan ke sheet Kegiatan_Sekolah.', 
      SpreadsheetApp.getUi().ButtonSet.OK);
  } catch (error) {
    SpreadsheetApp.getUi().alert('Test Gagal', 
      'Error: ' + error.message, 
      SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function generateSampleData() {
  try {
    // Sample kegiatan data
    const sampleKegiatan = [
      {
        id: 'KGT' + Date.now() + '001',
        nama_kegiatan: 'Rapat Koordinasi Guru',
        jenis_kegiatan: 'Manajemen',
        kategori_kegiatan: 'Rapat Guru',
        tanggal_mulai: '2025-02-01',
        tanggal_selesai: '2025-02-01',
        waktu_mulai: '08:00',
        waktu_selesai: '10:00',
        status: 'Terjadwal',
        penanggung_jawab: 'Kepala Sekolah',
        jumlah_peserta: 15,
        deskripsi: 'Rapat koordinasi bulanan untuk evaluasi pembelajaran',
        created_at: new Date().toISOString()
      },
      {
        id: 'KGT' + Date.now() + '002',
        nama_kegiatan: 'Workshop Kurikulum Merdeka',
        jenis_kegiatan: 'Akademik',
        kategori_kegiatan: 'Workshop',
        tanggal_mulai: '2025-02-05',
        tanggal_selesai: '2025-02-05',
        waktu_mulai: '13:00',
        waktu_selesai: '16:00',
        status: 'Terjadwal',
        penanggung_jawab: 'Wakil Kepala Sekolah',
        jumlah_peserta: 25,
        deskripsi: 'Pelatihan implementasi kurikulum merdeka untuk guru',
        created_at: new Date().toISOString()
      }
    ];
    
    sampleKegiatan.forEach(kegiatan =&gt; {
      handleCreateKegiatan(kegiatan);
    });
    
    SpreadsheetApp.getUi().alert('Sample Data Generated', 
      'Data contoh telah ditambahkan:\n- 2 Kegiatan sample\n\nSilakan cek di website untuk melihat data.', 
      SpreadsheetApp.getUi().ButtonSet.OK);
      
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error Generate Sample', 
      'Error: ' + error.message, 
      SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function generateTemplateGuru() {
  try {
    const templateGuru = [
      {
        id: 'G' + Date.now() + '001',
        nama_lengkap: 'Dr. Ahmad Suryadi, M.Pd',
        nip: '196501011990031001',
        jabatan: 'Kepala Sekolah',
        mata_pelajaran: 'Manajemen Pendidikan',
        kelas_diampu: 'Semua Kelas',
        email: 'ahmad.suryadi@sekolah.sch.id',
        no_telepon: '081234567890',
        alamat: 'Jl. Pendidikan No. 1',
        status: 'Aktif'
      },
      {
        id: 'G' + Date.now() + '002',
        nama_lengkap: 'Siti Nurhaliza, S.Pd',
        nip: '197203151998032002',
        jabatan: 'Wakil Kepala Sekolah',
        mata_pelajaran: 'Bahasa Indonesia',
        kelas_diampu: 'X, XI, XII',
        email: 'siti.nurhaliza@sekolah.sch.id',
        no_telepon: '081234567891',
        alamat: 'Jl. Guru No. 2',
        status: 'Aktif'
      },
      {
        id: 'G' + Date.now() + '003',
        nama_lengkap: 'Budi Santoso, S.Pd',
        nip: '198005102005011003',
        jabatan: 'Guru',
        mata_pelajaran: 'Matematika',
        kelas_diampu: 'X, XI IPA',
        email: 'budi.santoso@sekolah.sch.id',
        no_telepon: '081234567892',
        alamat: 'Jl. Matematika No. 3',
        status: 'Aktif'
      }
    ];
    
    templateGuru.forEach(guru =&gt; {
      handleCreateDataGuru(guru);
    });
    
    SpreadsheetApp.getUi().alert('Template Guru Generated', 
      'Template data guru telah ditambahkan:\n- 3 Data guru sample\n\nSilakan cek sheet Data_Guru_Staff.', 
      SpreadsheetApp.getUi().ButtonSet.OK);
      
  } catch (error) {
    SpreadsheetApp.getUi().alert('Error Generate Template Guru', 
      'Error: ' + error.message, 
      SpreadsheetApp.getUi().ButtonSet.OK);
  }
}

function clearAllData() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.alert('Konfirmasi', 
    'Apakah Anda yakin ingin menghapus semua data?\n(Headers akan tetap dipertahankan)', 
    ui.ButtonSet.YES_NO);
  
  if (response === ui.Button.YES) {
    Object.values(SHEETS).forEach(sheetName =&gt; {
      const sheet = getOrCreateSheetWithHeaders(sheetName);
      
      // Clear data but keep headers
      if (sheet.getLastRow() &gt; 1) {
        sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).clear();
      }
    });
    
    ui.alert('Data Terhapus', 'Semua data telah dihapus dari semua sheet.\nHeaders tetap dipertahankan.', ui.ButtonSet.OK);
  }
}</code></pre>
        </div>
        <div class="mt-2 flex space-x-2"><button onclick="copyToClipboard(this.previousElementSibling.querySelector('code').textContent)" class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600"> ðŸ“‹ Copy Code </button> <a href="https://script.google.com/home" target="_blank" rel="noopener noreferrer" class="text-xs bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600"> ðŸ”— Buka Apps Script </a>
        </div>
       </div>
       <div class="space-y-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Script URL</label> <input type="url" id="script-url" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="https://script.google.com/macros/s/..." value="https://script.google.com/macros/s/AKfycbzxUisl0681xILu8RnK7CjV8OHERqHwauAb02TnezwQfwfUCojn0EdrDtMKaW91Lvou/exec" readonly>
        </div>
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2"><button onclick="testScript()" class="btn-warning text-white px-4 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="play" class="w-4 h-4 inline mr-2"></i> Test Script </button> <button onclick="bacaDataDariGoogleSheets()" class="btn-primary text-white px-4 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="download" class="w-4 h-4 inline mr-2"></i> Muat Data </button> <button onclick="kirimDataManual()" class="btn-success text-white px-4 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="send" class="w-4 h-4 inline mr-2"></i> Kirim Data Manual </button>
        </div>
       </div>
      </div><!-- System Settings -->
      <div class="bg-white rounded-xl shadow-lg p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4">Pengaturan Sistem</h3>
       <div class="space-y-4">
        <div class="flex items-center justify-between">
         <div>
          <h4 class="font-medium text-gray-800">Auto Sync</h4>
          <p class="text-sm text-gray-600">Sinkronisasi otomatis dengan Google Sheets setiap 30 detik</p>
         </div><label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" id="auto-sync-toggle" class="sr-only peer" checked onchange="toggleAutoSyncSetting()">
          <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
        </div>
        <div class="flex items-center justify-between">
         <div>
          <h4 class="font-medium text-gray-800">Notifikasi Auto-Sync</h4>
          <p class="text-sm text-gray-600">Tampilkan notifikasi saat data diperbarui</p>
         </div><label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" id="sync-notifications" class="sr-only peer" checked>
          <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Interval Auto-Sync (detik)</label> <input type="number" id="sync-interval" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" value="30" min="10" max="300" onchange="updateSyncInterval()">
         <p class="text-xs text-gray-500 mt-1">Minimum 10 detik, maksimum 300 detik (5 menit)</p>
        </div><button onclick="resetSettings()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium transition-all duration-300 hover:shadow-lg active:scale-95 w-full"> <i data-lucide="rotate-ccw" class="w-4 h-4 inline mr-2"></i> Reset Pengaturan </button>
       </div>
      </div><!-- Backup & Restore -->
      <div class="bg-white rounded-xl shadow-lg p-6">
       <h3 class="text-xl font-bold text-gray-800 mb-4">Backup &amp; Restore</h3>
       <div class="space-y-4">
        <div>
         <h4 class="font-medium text-gray-800 mb-2">Backup Terakhir</h4>
         <p class="text-sm text-gray-600">25 Januari 2025, 14:30 WIB</p>
        </div>
        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4"><button onclick="createBackup()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="hard-drive" class="w-4 h-4 inline mr-2"></i> Buat Backup </button> <button onclick="restoreBackup()" class="btn-warning text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95"> <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i> Restore </button>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">Upload Backup File</label> <input type="file" accept=".json,.csv" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
        </div>
       </div>
      </div>
     </div>
    </section>
   </main>
  </div><!-- Overlay for mobile -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
  <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Mobile menu functionality
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        let isMobileMenuOpen = false;

        function toggleMobileMenu() {
            isMobileMenuOpen = !isMobileMenuOpen;
            
            if (isMobileMenuOpen) {
                sidebar.classList.add('open');
                overlay.classList.remove('hidden');
                mobileMenuBtn.innerHTML = '<i data-lucide="x" class="w-6 h-6 text-gray-700"></i>';
            } else {
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
                mobileMenuBtn.innerHTML = '<i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>';
            }
            
            lucide.createIcons();
        }

        mobileMenuBtn.addEventListener('click', toggleMobileMenu);
        overlay.addEventListener('click', toggleMobileMenu);

        // Sidebar navigation functionality
        document.querySelectorAll('.sidebar-item').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                console.log('ðŸ”„ Menu clicked:', btn.id);
                
                // Show loading notification
                showNotification('ðŸ”„ Memuat halaman...', 'info');
                
                // Hide all sections with fade out
                document.querySelectorAll('.section').forEach(sec => {
                    sec.style.opacity = '0';
                    sec.style.transform = 'translateY(10px)';
                    setTimeout(() => {
                        sec.classList.add('hidden');
                    }, 150);
                });
                
                // Remove active class from all menu items
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Add active class to clicked item with animation
                btn.classList.add('active');
                
                // Show target section with smooth animation
                const targetId = btn.id.replace('menu-', '') + '-section';
                const target = document.getElementById(targetId);
                
                if (target) {
                    setTimeout(() => {
                        target.classList.remove('hidden');
                        target.style.opacity = '0';
                        target.style.transform = 'translateY(20px)';
                        
                        // Trigger animation
                        setTimeout(() => {
                            target.style.transition = 'all 0.3s ease-out';
                            target.style.opacity = '1';
                            target.style.transform = 'translateY(0)';
                            target.classList.add('fade-in');
                        }, 50);
                        
                        // Update page title
                        updatePageTitle(btn.id.replace('menu-', ''));
                        console.log('âœ… Section shown:', targetId);
                        
                        // Success notification
                        setTimeout(() => {
                            showNotification('âœ… Halaman berhasil dimuat!', 'success');
                        }, 200);
                        
                    }, 200);
                } else {
                    console.error('âŒ Target section not found:', targetId);
                    showNotification('âŒ Halaman tidak ditemukan!', 'error');
                }
                
                // Close mobile menu if open
                if (isMobileMenuOpen) {
                    toggleMobileMenu();
                }
            });
        });

        // Update page title and subtitle
        function updatePageTitle(section) {
            const pageTitle = document.getElementById('page-title');
            const pageSubtitle = document.getElementById('page-subtitle');
            
            const titles = {
                'dashboard': {
                    title: 'Dashboard',
                    subtitle: 'Selamat datang di sistem kegiatan sekolah'
                },
                'agenda': {
                    title: 'Agenda Kegiatan',
                    subtitle: 'Kelola dan atur jadwal kegiatan sekolah'
                },
                'rekap': {
                    title: 'Rekap Kegiatan',
                    subtitle: 'Laporan dan statistik kegiatan sekolah'
                },
                'berita-acara': {
                    title: 'Berita Acara',
                    subtitle: 'Generate dan kelola berita acara kegiatan'
                },
                'daftar-hadir': {
                    title: 'Daftar Hadir',
                    subtitle: 'Template daftar hadir untuk kegiatan'
                },
                'pengaturan': {
                    title: 'Pengaturan',
                    subtitle: 'Konfigurasi sistem dan integrasi'
                }
            };
            
            if (titles[section]) {
                pageTitle.textContent = titles[section].title;
                pageSubtitle.textContent = titles[section].subtitle;
            }
        }

        // Global data storage - mulai kosong, akan diisi dari Google Sheets
        let kegiatanData = [];
        let savedBeritaAcara = [];
        let savedDaftarHadir = [];
        let pesertaDaftarHadir = []; // Array untuk menyimpan peserta sementara
        
        // Auto-sync configuration
        let autoSyncEnabled = true;
        let autoSyncInterval = null;
        let lastDataHash = null;
        let isTabActive = true;
        let syncIntervalSeconds = 30;

        // Tab visibility handling
        document.addEventListener('visibilitychange', function() {
            isTabActive = !document.hidden;
            
            if (isTabActive && autoSyncEnabled) {
                console.log('ðŸ”„ Tab active - resuming auto-sync');
                startAutoSync();
                // Immediate sync when tab becomes active
                setTimeout(() => {
                    autoSyncData();
                }, 1000);
            } else if (!isTabActive) {
                console.log('â¸ï¸ Tab inactive - pausing auto-sync');
                stopAutoSync();
            }
        });

        // Auto-sync functions
        function startAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }
            
            if (autoSyncEnabled && isTabActive) {
                autoSyncInterval = setInterval(() => {
                    autoSyncData();
                }, syncIntervalSeconds * 1000);
                
                console.log(`ðŸ”„ Auto-sync started with ${syncIntervalSeconds}s interval`);
                updateAutoSyncIndicator('active');
            }
        }

        function stopAutoSync() {
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
            console.log('â¹ï¸ Auto-sync stopped');
        }

        function toggleAutoSync() {
            autoSyncEnabled = !autoSyncEnabled;
            
            const toggleBtn = document.getElementById('toggle-auto-sync');
            const indicator = document.getElementById('auto-sync-indicator');
            const text = document.getElementById('auto-sync-text');
            
            if (autoSyncEnabled) {
                toggleBtn.textContent = 'ON';
                toggleBtn.className = 'text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition-colors';
                text.textContent = 'Auto-sync';
                text.className = 'text-sm text-green-600 font-medium';
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full pulse-green';
                
                startAutoSync();
                showNotification('âœ… Auto-sync diaktifkan!', 'success');
            } else {
                toggleBtn.textContent = 'OFF';
                toggleBtn.className = 'text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors';
                text.textContent = 'Manual';
                text.className = 'text-sm text-gray-600 font-medium';
                indicator.className = 'w-3 h-3 bg-gray-400 rounded-full';
                
                stopAutoSync();
                showNotification('â¸ï¸ Auto-sync dinonaktifkan', 'info');
            }
        }

        function toggleAutoSyncSetting() {
            const checkbox = document.getElementById('auto-sync-toggle');
            autoSyncEnabled = checkbox.checked;
            
            if (autoSyncEnabled) {
                startAutoSync();
            } else {
                stopAutoSync();
            }
            
            // Update header toggle
            const headerToggle = document.getElementById('toggle-auto-sync');
            headerToggle.textContent = autoSyncEnabled ? 'ON' : 'OFF';
            headerToggle.className = autoSyncEnabled ? 
                'text-xs bg-green-100 hover:bg-green-200 text-green-700 px-2 py-1 rounded transition-colors' :
                'text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-2 py-1 rounded transition-colors';
            
            updateAutoSyncIndicator(autoSyncEnabled ? 'active' : 'inactive');
        }

        function updateSyncInterval() {
            const intervalInput = document.getElementById('sync-interval');
            const newInterval = parseInt(intervalInput.value);
            
            if (newInterval >= 10 && newInterval <= 300) {
                syncIntervalSeconds = newInterval;
                
                // Restart auto-sync with new interval
                if (autoSyncEnabled) {
                    stopAutoSync();
                    startAutoSync();
                }
                
                showNotification(`âš™ï¸ Interval auto-sync diubah ke ${newInterval} detik`, 'info');
            } else {
                intervalInput.value = syncIntervalSeconds;
                showNotification('âš ï¸ Interval harus antara 10-300 detik', 'warning');
            }
        }

        function updateAutoSyncIndicator(status) {
            const indicator = document.getElementById('auto-sync-indicator');
            const text = document.getElementById('auto-sync-text');
            
            switch (status) {
                case 'active':
                    indicator.className = 'w-3 h-3 bg-green-500 rounded-full pulse-green';
                    text.textContent = 'Auto-sync';
                    text.className = 'text-sm text-green-600 font-medium';
                    break;
                case 'syncing':
                    indicator.className = 'w-3 h-3 bg-blue-500 rounded-full pulse-blue';
                    text.textContent = 'Syncing...';
                    text.className = 'text-sm text-blue-600 font-medium';
                    break;
                case 'updated':
                    indicator.className = 'w-3 h-3 bg-blue-500 rounded-full pulse-blue';
                    text.textContent = 'Data Diperbarui';
                    text.className = 'text-sm text-blue-600 font-medium';
                    // Reset to active after 3 seconds
                    setTimeout(() => {
                        if (autoSyncEnabled) {
                            updateAutoSyncIndicator('active');
                        }
                    }, 3000);
                    break;
                case 'inactive':
                    indicator.className = 'w-3 h-3 bg-gray-400 rounded-full';
                    text.textContent = 'Manual';
                    text.className = 'text-sm text-gray-600 font-medium';
                    break;
            }
        }

        // Auto-sync data function
        async function autoSyncData() {
            if (!autoSyncEnabled || !isTabActive) {
                return;
            }
            
            try {
                console.log('ðŸ”„ Auto-sync: Checking for data changes...');
                updateAutoSyncIndicator('syncing');
                
                const success = await bacaDataDariGoogleSheets(true); // Silent mode
                
                if (success) {
                    console.log('âœ… Auto-sync: Data check completed');
                } else {
                    console.log('âš ï¸ Auto-sync: No changes detected');
                }
                
            } catch (error) {
                console.error('âŒ Auto-sync error:', error);
            }
        }

        // Generate hash for data comparison
        function generateDataHash(data) {
            return JSON.stringify(data).split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
        }

        // Kategori data berdasarkan jenis kegiatan
        const kategoriData = {
            'Akademik': [
                { value: 'KBM', text: 'Kegiatan Belajar Mengajar (KBM)' },
                { value: 'Ulangan', text: 'Ulangan Harian, UTS, UAS' },
                { value: 'PAS/PAT', text: 'Penilaian Akhir Semester/Tahun' },
                { value: 'ANBK', text: 'ANBK (Asesmen Nasional)' },
                { value: 'Olimpiade', text: 'Olimpiade Sains/Matematika/Bahasa' },
                { value: 'Karya Tulis', text: 'Lomba Karya Tulis Ilmiah' },
                { value: 'BK Akademik', text: 'Bimbingan Konseling Akademik' },
                { value: 'Literasi', text: 'Program Literasi Sekolah' },
                { value: 'Remedial', text: 'Kegiatan Remedial dan Pengayaan' },
                { value: 'Praktikum', text: 'Praktikum IPA/Lab Komputer' },
                { value: 'P5', text: 'P5 (Projek Profil Pelajar Pancasila)' }
            ],
            'Non-Akademik': [
                { value: 'Pramuka', text: 'Pramuka' },
                { value: 'OSIS', text: 'OSIS' },
                { value: 'Paskibra', text: 'Paskibra' },
                { value: 'PMR', text: 'PMR (Palang Merah Remaja)' },
                { value: 'Rohani', text: 'Rohis/Rohkris/Rohani Sekolah' },
                { value: 'Kesenian', text: 'Kesenian (Tari/Musik/Teater)' },
                { value: 'Olahraga', text: 'Olahraga (Futsal/Voli/Basket)' },
                { value: 'KIR', text: 'Karya Ilmiah Remaja (KIR)' },
                { value: 'Jurnalistik', text: 'Jurnalistik/Mading Sekolah' },
                { value: 'Lomba Kelas', text: 'Lomba Antar Kelas' },
                { value: 'Pentas Seni', text: 'Pentas Seni dan Gebyar' }
            ],
            'Kesiswaan': [
                { value: 'Upacara', text: 'Upacara Bendera' },
                { value: 'LDKS', text: 'Pelatihan Kepemimpinan (LDKS)' },
                { value: 'Pesantren Kilat', text: 'Pesantren Kilat/Retret' },
                { value: 'Baksos', text: 'Bakti Sosial (Baksos)' },
                { value: 'HUT RI', text: 'Peringatan 17 Agustus' },
                { value: 'Hari Nasional', text: 'Hari Besar Nasional' },
                { value: 'Hari Keagamaan', text: 'Hari Besar Keagamaan' },
                { value: 'Study Tour', text: 'Study Tour/Kunjungan Edukasi' },
                { value: 'Persami', text: 'Perkemahan Sabtu Minggu' },
                { value: 'Adiwiyata', text: 'Lomba Adiwiyata' }
            ],
            'Manajemen': [
                { value: 'Rapat Guru', text: 'Rapat Dewan Guru' },
                { value: 'Workshop', text: 'Workshop Kurikulum Merdeka' },
                { value: 'Evaluasi', text: 'Rapat Evaluasi Bulanan' },
                { value: 'Supervisi', text: 'Supervisi dan Monitoring' },
                { value: 'Pelatihan Guru', text: 'Pelatihan Kompetensi Guru' },
                { value: 'Akreditasi', text: 'Kegiatan Akreditasi' },
                { value: 'Dapodik', text: 'Dapodik, BOS, SIMPEG' },
                { value: 'Rapor Pendidikan', text: 'Evaluasi Rapor Pendidikan' },
                { value: 'Audit', text: 'Kegiatan Audit dan Keuangan' }
            ],
            'Lingkungan': [
                { value: 'Adiwiyata Program', text: 'Program Adiwiyata' },
                { value: 'Penanaman', text: 'Penanaman Pohon/Kebun' },
                { value: 'Jumat Bersih', text: 'Gerakan Jumat Bersih' },
                { value: 'Bank Sampah', text: 'Bank Sampah Sekolah' },
                { value: 'Donasi', text: 'Donasi Korban Bencana' },
                { value: 'Sekolah Sehat', text: 'Program Sekolah Sehat' },
                { value: 'MBG', text: 'Makan Bergizi Gratis' },
                { value: 'Gotong Royong', text: 'Gotong Royong Warga' }
            ],
            'Khusus': [
                { value: 'Ujian Sekolah', text: 'Ujian Sekolah/USBK' },
                { value: 'UKK', text: 'Ujian Kompetensi Keahlian' },
                { value: 'PKL', text: 'Praktik Kerja Lapangan' },
                { value: 'Kunjungan Industri', text: 'Kunjungan Industri' },
                { value: 'Wisuda', text: 'Wisuda/Pelepasan Siswa' },
                { value: 'Class Meeting', text: 'Class Meeting' },
                { value: 'PPDB', text: 'Penerimaan Siswa Baru' },
                { value: 'MPLS', text: 'MPLS (Pengenalan Lingkungan)' },
                { value: 'Raker', text: 'Rapat Kerja Tahunan' },
                { value: 'Pelantikan', text: 'Pelantikan OSIS/Ekstrakurikuler' }
            ]
        };

        // Update kategori options based on selected jenis
        function updateKategoriOptions() {
            const jenisSelect = document.getElementById('jenis-kegiatan');
            const kategoriSelect = document.getElementById('kategori-kegiatan');
            const selectedJenis = jenisSelect.value;
            
            // Clear existing options
            kategoriSelect.innerHTML = '';
            
            if (!selectedJenis) {
                kategoriSelect.innerHTML = '<option value="">Pilih Jenis Kegiatan terlebih dahulu</option>';
                return;
            }
            
            // Add default option
            kategoriSelect.innerHTML = '<option value="">Pilih Kategori Kegiatan</option>';
            
            // Add options based on selected jenis
            if (kategoriData[selectedJenis]) {
                kategoriData[selectedJenis].forEach(kategori => {
                    const option = document.createElement('option');
                    option.value = kategori.value;
                    option.textContent = kategori.text;
                    kategoriSelect.appendChild(option);
                });
            }
            
            console.log('âœ… Kategori options updated for jenis:', selectedJenis);
        }
        
        // Refresh Data Function
        function refreshData() {
            console.log('ðŸ”„ Refresh data clicked');
            
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i>Refreshing...';
            button.disabled = true;
            
            // Add rotation animation to refresh icon
            const refreshIcon = button.querySelector('[data-lucide="refresh-cw"], [data-lucide="loader-2"]');
            if (refreshIcon) {
                refreshIcon.style.animation = 'spin 1s linear infinite';
            }
            
            showNotification('ðŸ”„ Memuat ulang data...', 'info');
            
            // Simulate refresh process
            setTimeout(async () => {
                try {
                    // Try to load data from Google Sheets
                    const success = await bacaDataDariGoogleSheets();
                    
                    if (success) {
                        showNotification('âœ… Data berhasil diperbarui dari Google Sheets!', 'success');
                    } else {
                        // Update local data display
                        updateDashboard();
                        updateAgendaList();
                        updateRekapData();
                        updateBeritaAcaraFilters();
                        updateDaftarHadirFilters();
                        showNotification('ðŸ”„ Data lokal berhasil diperbarui!', 'info');
                    }
                } catch (error) {
                    console.error('Error refreshing data:', error);
                    showNotification('âš ï¸ Refresh selesai dengan peringatan', 'warning');
                } finally {
                    // Restore button state
                    button.innerHTML = originalText;
                    button.disabled = false;
                    lucide.createIcons();
                }
            }, 1500);
        }

        // Kegiatan functions
        function tambahKegiatan() {
            console.log('Tambah kegiatan clicked');
            const form = document.getElementById('form-kegiatan');
            form.classList.toggle('hidden');
            
            if (!form.classList.contains('hidden')) {
                form.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function simpanKegiatan(event) {
            event.preventDefault();
            console.log('Simpan kegiatan clicked');
            
            // Show loading state
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i>Menyimpan...';
            submitBtn.disabled = true;
            
            const namaKegiatan = document.getElementById('nama-kegiatan').value;
            const jenisKegiatan = document.getElementById('jenis-kegiatan').value;
            const kategoriKegiatan = document.getElementById('kategori-kegiatan').value;
            const tanggalMulai = document.getElementById('tanggal-mulai').value;
            const tanggalSelesai = document.getElementById('tanggal-selesai').value;
            const waktuMulai = document.getElementById('waktu-mulai').value;
            const waktuSelesai = document.getElementById('waktu-selesai').value;
            const statusKegiatan = document.getElementById('status-kegiatan').value;
            const penanggungJawab = document.getElementById('penanggung-jawab').value;
            const jumlahPeserta = parseInt(document.getElementById('jumlah-peserta').value) || 0;
            const deskripsiKegiatan = document.getElementById('deskripsi-kegiatan').value;
            const dokumentasi = document.getElementById('dokumentasi').files[0];
            
            // Generate ID unik
            const id = 'KGT' + Date.now();
            
            // Convert image to base64 if exists
            let fotoBase64 = '';
            if (dokumentasi) {
                try {
                    fotoBase64 = await convertToBase64(dokumentasi);
                } catch (error) {
                    console.error('Error converting image:', error);
                }
            }
            
            const dataKegiatan = {
                id: id,
                nama: namaKegiatan,
                jenis: jenisKegiatan,
                kategori: kategoriKegiatan,
                tanggalMulai: tanggalMulai,
                tanggalSelesai: tanggalSelesai,
                waktuMulai: waktuMulai,
                waktuSelesai: waktuSelesai,
                status: statusKegiatan,
                penanggungJawab: penanggungJawab,
                jumlahPeserta: jumlahPeserta,
                deskripsi: deskripsiKegiatan,
                dokumentasi: dokumentasi ? dokumentasi.name : '',
                fotoBase64: fotoBase64,
                createdAt: new Date().toISOString()
            };
            
            console.log('Data kegiatan lengkap:', dataKegiatan);
            
            try {
                // Kirim ke Google Sheets
                const success = await kirimKeGoogleSheets(dataKegiatan);
                
                if (success) {
                    // Add to local data
                    kegiatanData.push(dataKegiatan);
                    
                    // Update UI
                    updateDashboard();
                    updateAgendaList();
                    updateRekapData();
                    updateBeritaAcaraFilters();
                    updateDaftarHadirFilters();
                    
                    // Show success message
                    showNotification(`Kegiatan "${namaKegiatan}" berhasil disimpan dan dikirim ke Google Sheets!`, 'success');
                    
                    // Reset form and hide
                    event.target.reset();
                    document.getElementById('form-kegiatan').classList.add('hidden');
                } else {
                    showNotification('Gagal menyimpan ke Google Sheets. Data disimpan lokal.', 'warning');
                    
                    // Still add to local data
                    kegiatanData.push(dataKegiatan);
                    updateDashboard();
                    updateAgendaList();
                    updateRekapData();
                    updateBeritaAcaraFilters();
                    updateDaftarHadirFilters();
                }
                
            } catch (error) {
                console.error('Error saving kegiatan:', error);
                showNotification('Terjadi kesalahan saat menyimpan data.', 'error');
            } finally {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                lucide.createIcons();
            }
        }
        
        // Convert file to base64
        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Fungsi untuk membaca data dari Google Sheets - IMPROVED VERSION WITH AUTO-SYNC
        async function bacaDataDariGoogleSheets(silentMode = false) {
            const scriptUrl = document.getElementById('script-url').value;
            
            if (!scriptUrl) {
                if (!silentMode) {
                    console.log('Script URL belum diatur');
                    showNotification('âš ï¸ Script URL belum dikonfigurasi!', 'warning');
                }
                return false;
            }
            
            try {
                if (!silentMode) {
                    console.log('ðŸ“– Membaca data dari Google Sheets...');
                    showNotification('ðŸ“– Memuat data dari Google Sheets...', 'info');
                }
                
                // Method 1: Try direct fetch with proper headers
                try {
                    const directResponse = await fetch(scriptUrl + '?action=read&timestamp=' + Date.now(), {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (directResponse.ok) {
                        const data = await directResponse.json();
                        
                        if (data.success && data.data && Array.isArray(data.data)) {
                            // Generate hash for change detection
                            const newDataHash = generateDataHash(data.data);
                            
                            // Check if data has changed
                            if (lastDataHash !== null && lastDataHash === newDataHash) {
                                if (!silentMode) {
                                    console.log('ðŸ“Š No changes detected in data');
                                    showNotification('â„¹ï¸ Tidak ada perubahan data', 'info');
                                }
                                return false;
                            }
                            
                            // Update data hash
                            lastDataHash = newDataHash;
                            
                            // Process new data
                            const oldDataLength = kegiatanData.length;
                            kegiatanData = data.data.map(row => ({
                                id: row[0] || '',
                                nama: row[1] || '',
                                jenis: row[2] || '',
                                kategori: row[3] || '',
                                tanggalMulai: row[4] || '',
                                tanggalSelesai: row[5] || '',
                                waktuMulai: row[6] || '',
                                waktuSelesai: row[7] || '',
                                status: row[8] || '',
                                penanggungJawab: row[9] || '',
                                jumlahPeserta: parseInt(row[10]) || 0,
                                deskripsi: row[11] || '',
                                dokumentasi: row[12] || '',
                                createdAt: row[13] || new Date().toISOString()
                            }));
                            
                            console.log('ðŸ“Š Processed data:', kegiatanData);
                            
                            // Update UI
                            updateDashboard();
                            updateAgendaList();
                            updateRekapData();
                            updateBeritaAcaraFilters();
                            updateDaftarHadirFilters();
                            
                            // Show appropriate notification
                            if (silentMode) {
                                // Auto-sync mode - show update indicator
                                updateAutoSyncIndicator('updated');
                                
                                // Show notification based on data changes
                                const newDataLength = kegiatanData.length;
                                if (newDataLength > oldDataLength) {
                                    const addedCount = newDataLength - oldDataLength;
                                    showNotification(`ðŸ†• ${addedCount} kegiatan baru ditambahkan`, 'success');
                                } else if (newDataLength < oldDataLength) {
                                    const removedCount = oldDataLength - newDataLength;
                                    showNotification(`ðŸ—‘ï¸ ${removedCount} kegiatan dihapus`, 'info');
                                } else {
                                    showNotification(`ðŸ”„ Data kegiatan diperbarui`, 'info');
                                }
                            } else {
                                showNotification(`âœ… Berhasil memuat ${kegiatanData.length} kegiatan dari Google Sheets!`, 'success');
                            }
                            
                            return true;
                        } else {
                            if (!silentMode) {
                                console.log('âš ï¸ Data format tidak sesuai atau kosong');
                                showNotification('âš ï¸ Data kosong atau format tidak sesuai', 'warning');
                            }
                            return false;
                        }
                    }
                } catch (directError) {
                    console.log('âš ï¸ Direct fetch gagal:', directError.message);
                }
                
                // Method 2: Try with no-cors mode (fallback)
                try {
                    const noCorsResponse = await fetch(scriptUrl + '?action=read&timestamp=' + Date.now(), {
                        method: 'GET',
                        mode: 'no-cors'
                    });
                    
                    // For no-cors, we can't read the response but assume success if no error
                    if (noCorsResponse.type === 'opaque') {
                        if (!silentMode) {
                            console.log('âœ… No-cors request sent successfully');
                            showNotification('ðŸ“– Request terkirim. Coba refresh halaman untuk melihat data.', 'info');
                        }
                        return true;
                    }
                } catch (noCorsError) {
                    console.log('âš ï¸ No-cors method gagal:', noCorsError.message);
                }
                
                // If all methods fail
                if (!silentMode) {
                    showNotification('âš ï¸ Tidak dapat membaca data. Pastikan Apps Script sudah di-deploy dengan benar.', 'warning');
                }
                return false;
                
            } catch (error) {
                console.error('âŒ Error membaca dari Google Sheets:', error);
                if (!silentMode) {
                    showNotification('âŒ Gagal membaca data: ' + error.message, 'error');
                }
                return false;
            }
        }

        // Fungsi untuk mengirim data ke Google Sheets
        async function kirimKeGoogleSheets(data) {
            const scriptUrl = document.getElementById('script-url').value;
            
            if (!scriptUrl) {
                console.log('Script URL belum diatur');
                showNotification('Script URL belum dikonfigurasi!', 'warning');
                return false;
            }
            
            try {
                console.log('ðŸš€ Mengirim data ke Google Sheets:', data);
                
                // Prepare data for Google Sheets with proper structure
                const payload = {
                    action: 'CREATE',
                    data: {
                        id: data.id || '',
                        nama_kegiatan: data.nama || '',
                        jenis_kegiatan: data.jenis || '',
                        kategori_kegiatan: data.kategori || '',
                        tanggal_mulai: data.tanggalMulai || '',
                        tanggal_selesai: data.tanggalSelesai || '',
                        waktu_mulai: data.waktuMulai || '',
                        waktu_selesai: data.waktuSelesai || '',
                        status: data.status || '',
                        penanggung_jawab: data.penanggungJawab || '',
                        jumlah_peserta: data.jumlahPeserta || 0,
                        deskripsi: data.deskripsi || '',
                        dokumentasi: data.dokumentasi || '',
                        created_at: data.createdAt || new Date().toISOString()
                    }
                };
                
                console.log('ðŸ“¤ Payload yang dikirim:', payload);
                
                // Show loading indicator
                showNotification('ðŸ“¤ Mengirim data ke Google Sheets...', 'info');
                
                // Use multiple methods to ensure data is sent
                const methods = [
                    // Method 1: Standard fetch
                    async () => {
                        const response = await fetch(scriptUrl, {
                            method: 'POST',
                            mode: 'no-cors', // Important for Google Apps Script
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload)
                        });
                        return response;
                    },
                    
                    // Method 2: Form data approach
                    async () => {
                        const formData = new FormData();
                        formData.append('data', JSON.stringify(payload));
                        
                        const response = await fetch(scriptUrl, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: formData
                        });
                        return response;
                    },
                    
                    // Method 3: URL encoded
                    async () => {
                        const params = new URLSearchParams();
                        params.append('data', JSON.stringify(payload));
                        
                        const response = await fetch(scriptUrl, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: params
                        });
                        return response;
                    }
                ];
                
                // Try each method
                for (let i = 0; i < methods.length; i++) {
                    try {
                        console.log(`ðŸ”„ Mencoba method ${i + 1}...`);
                        const response = await methods[i]();
                        
                        console.log(`ðŸ“¥ Response method ${i + 1}:`, response);
                        
                        // For no-cors mode, we can't read the response but if no error thrown, assume success
                        if (response.type === 'opaque' || response.status === 0 || response.ok) {
                            console.log(`âœ… Method ${i + 1} berhasil!`);
                            showNotification('âœ… Data berhasil dikirim ke Google Sheets!', 'success');
                            
                            // Trigger auto-sync after successful send
                            setTimeout(() => {
                                if (autoSyncEnabled) {
                                    autoSyncData();
                                }
                            }, 2000);
                            
                            return true;
                        }
                        
                    } catch (methodError) {
                        console.log(`âš ï¸ Method ${i + 1} gagal:`, methodError.message);
                        if (i === methods.length - 1) {
                            throw methodError; // Throw on last attempt
                        }
                    }
                }
                
                // If all methods fail
                throw new Error('Semua method pengiriman gagal');
                
            } catch (error) {
                console.error('âŒ Error mengirim ke Google Sheets:', error);
                
                // For CORS or network errors with Google Apps Script, assume success
                if (error.message.includes('CORS') || 
                    error.message.includes('fetch') || 
                    error.message.includes('NetworkError') ||
                    error.name === 'TypeError') {
                    console.log('âš ï¸ Network/CORS error - data mungkin tetap terkirim');
                    showNotification('âš ï¸ Data dikirim! (Cek Google Sheets untuk konfirmasi)', 'warning');
                    
                    // Trigger auto-sync after potential send
                    setTimeout(() => {
                        if (autoSyncEnabled) {
                            autoSyncData();
                        }
                    }, 3000);
                    
                    return true; // Assume success for common Google Apps Script issues
                }
                
                showNotification('âŒ Gagal mengirim ke Google Sheets: ' + error.message, 'error');
                return false;
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            // Don't show notifications if sync notifications are disabled
            const syncNotifications = document.getElementById('sync-notifications');
            if (syncNotifications && !syncNotifications.checked && 
                (message.includes('Auto-sync') || message.includes('Data Diperbarui') || message.includes('kegiatan baru') || message.includes('kegiatan dihapus'))) {
                return;
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transition-all duration-300 transform translate-x-full`;
            
            const bgColor = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'warning': 'bg-yellow-500',
                'info': 'bg-blue-500'
            }[type] || 'bg-blue-500';
            
            notification.className += ` ${bgColor} text-white`;
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : type === 'warning' ? 'alert-triangle' : 'info'}" class="w-5 h-5"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            lucide.createIcons();
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        function batalTambah() {
            console.log('Batal tambah clicked');
            document.getElementById('form-kegiatan').classList.add('hidden');
        }

        function editKegiatan(id) {
            console.log('Edit kegiatan clicked, ID:', id);
            showNotification(`Edit kegiatan dengan ID: ${id}`, 'info');
        }

        function hapusKegiatan(id) {
            console.log('Hapus kegiatan clicked, ID:', id);
            // Create inline confirmation instead of browser confirm
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            confirmModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="text-center">
                        <i data-lucide="trash-2" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Hapus Kegiatan</h3>
                        <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus kegiatan ini?</p>
                        
                        <div class="flex space-x-4">
                            <button onclick="confirmHapusKegiatan('${id}'); this.parentElement.parentElement.parentElement.parentElement.remove();" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Ya, Hapus
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove();" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            lucide.createIcons();
        }
        
        function confirmHapusKegiatan(id) {
            // Remove from local data
            const index = kegiatanData.findIndex(k => k.id === id);
            if (index !== -1) {
                kegiatanData.splice(index, 1);
                updateDashboard();
                updateAgendaList();
                updateRekapData();
                showNotification(`Kegiatan dengan ID ${id} berhasil dihapus!`, 'success');
            }
        }

        // Update Dashboard
        function updateDashboard() {
            // Update stats
            document.getElementById('total-kegiatan').textContent = kegiatanData.length;
            
            // Calculate today's activities
            const today = new Date().toISOString().split('T')[0];
            const todayActivities = kegiatanData.filter(k => k.tanggalMulai === today || k.tanggalSelesai === today);
            document.getElementById('kegiatan-hari-ini').textContent = todayActivities.length;
            
            // Calculate total participants
            const totalPeserta = kegiatanData.reduce((sum, k) => sum + (k.jumlahPeserta || 0), 0);
            document.getElementById('peserta-aktif').textContent = totalPeserta;
            
            // Calculate completion rate
            const selesaiCount = kegiatanData.filter(k => k.status === 'Selesai').length;
            const completionRate = kegiatanData.length > 0 ? Math.round((selesaiCount / kegiatanData.length) * 100) : 0;
            document.getElementById('tingkat-kehadiran').textContent = completionRate + '%';
            
            // Update recent activities
            updateRecentActivities();
        }
        
        // Update Recent Activities
        function updateRecentActivities() {
            const container = document.getElementById('recent-activities-container');
            
            if (kegiatanData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i data-lucide="calendar-x" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                        <p class="text-gray-500 mb-2">Belum ada kegiatan</p>
                        <p class="text-sm text-gray-400">Tambah kegiatan baru atau muat data dari Google Sheets</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            // Sort by creation date and take last 5
            const recentActivities = [...kegiatanData]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);
            
            container.innerHTML = recentActivities.map(activity => {
                const statusColor = {
                    'Terjadwal': 'bg-yellow-100 text-yellow-800',
                    'Berlangsung': 'bg-blue-100 text-blue-800',
                    'Selesai': 'bg-green-100 text-green-800',
                    'Dibatalkan': 'bg-red-100 text-red-800'
                }[activity.status] || 'bg-gray-100 text-gray-800';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-800">${activity.nama}</h4>
                            <p class="text-sm text-gray-600">${formatTanggal(activity.tanggalMulai)} â€¢ ${activity.penanggungJawab}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 ${statusColor} rounded-full text-xs font-medium">${activity.status}</span>
                            <button onclick="lihatDetail('${activity.id}')" class="text-blue-600 hover:text-blue-800 transition-colors">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        // Update Agenda List
        function updateAgendaList() {
            const container = document.getElementById('agenda-list-container');
            
            if (kegiatanData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="calendar-plus" class="w-20 h-20 text-gray-300 mx-auto mb-4"></i>
                        <h4 class="text-lg font-semibold text-gray-600 mb-2">Belum Ada Kegiatan</h4>
                        <p class="text-gray-500 mb-4">Mulai dengan menambah kegiatan baru atau muat data dari Google Sheets</p>
                        <div class="flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4">
                            <button onclick="tambahKegiatan()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-2"></i>
                                Tambah Kegiatan
                            </button>
                            <button onclick="bacaDataDariGoogleSheets()" class="btn-success text-white px-6 py-2 rounded-lg font-medium hover:shadow-lg transition-all duration-300 active:scale-95">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Muat dari Google Sheets
                            </button>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            // Sort by date
            const sortedData = [...kegiatanData].sort((a, b) => new Date(a.tanggalMulai) - new Date(b.tanggalMulai));
            
            container.innerHTML = sortedData.map(kegiatan => {
                const statusColor = {
                    'Terjadwal': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                    'Berlangsung': 'bg-blue-100 text-blue-800 border-blue-200',
                    'Selesai': 'bg-green-100 text-green-800 border-green-200',
                    'Dibatalkan': 'bg-red-100 text-red-800 border-red-200'
                }[kegiatan.status] || 'bg-gray-100 text-gray-800 border-gray-200';
                
                const jenisColor = {
                    'Akademik': 'bg-purple-100 text-purple-800',
                    'Non-Akademik': 'bg-green-100 text-green-800',
                    'Kesiswaan': 'bg-blue-100 text-blue-800',
                    'Manajemen': 'bg-orange-100 text-orange-800',
                    'Lingkungan': 'bg-emerald-100 text-emerald-800',
                    'Khusus': 'bg-red-100 text-red-800'
                }[kegiatan.jenis] || 'bg-gray-100 text-gray-800';
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">${kegiatan.nama}</h4>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <span class="px-3 py-1 ${jenisColor} rounded-full text-sm font-medium">${kegiatan.jenis}</span>
                                    <span class="px-3 py-1 ${statusColor} rounded-full text-sm font-medium border">${kegiatan.status}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 text-sm">
                            <div>
                                <span class="text-gray-500">Kategori:</span>
                                <p class="font-medium text-gray-700">${kegiatan.kategori}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Tanggal:</span>
                                <p class="font-medium text-gray-700">${formatTanggal(kegiatan.tanggalMulai)}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Waktu:</span>
                                <p class="font-medium text-gray-700">${kegiatan.waktuMulai} - ${kegiatan.waktuSelesai}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Peserta:</span>
                                <p class="font-medium text-gray-700">${kegiatan.jumlahPeserta || 0} orang</p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <span class="text-gray-500 text-sm">Penanggung Jawab:</span>
                            <p class="font-medium text-gray-700">${kegiatan.penanggungJawab}</p>
                        </div>
                        
                        ${kegiatan.deskripsi ? `
                        <div class="mb-4">
                            <span class="text-gray-500 text-sm">Deskripsi:</span>
                            <p class="text-gray-700 text-sm mt-1">${kegiatan.deskripsi}</p>
                        </div>
                        ` : ''}
                        
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                            <button onclick="lihatDetail('${kegiatan.id}')" class="btn-primary text-white px-4 py-2 rounded-lg font-medium text-sm">
                                <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                                Lihat Detail
                            </button>
                            <button onclick="editKegiatan('${kegiatan.id}')" class="btn-warning text-white px-4 py-2 rounded-lg font-medium text-sm">
                                <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                                Edit
                            </button>
                            <button onclick="hapusKegiatan('${kegiatan.id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                                Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        // Update Rekap Data
        function updateRekapData() {
            // Update statistics
            document.getElementById('rekap-total-kegiatan').textContent = kegiatanData.length;
            
            const selesaiCount = kegiatanData.filter(k => k.status === 'Selesai').length;
            document.getElementById('rekap-kegiatan-selesai').textContent = selesaiCount;
            
            const completionRate = kegiatanData.length > 0 ? Math.round((selesaiCount / kegiatanData.length) * 100) : 0;
            document.getElementById('rekap-persentase-selesai').textContent = completionRate + '% tingkat penyelesaian';
            
            const totalPeserta = kegiatanData.reduce((sum, k) => sum + (k.jumlahPeserta || 0), 0);
            document.getElementById('rekap-total-peserta').textContent = totalPeserta;
            
            const avgPeserta = kegiatanData.length > 0 ? Math.round(totalPeserta / kegiatanData.length) : 0;
            document.getElementById('rekap-rata-rata-peserta').textContent = `Rata-rata ${avgPeserta} per kegiatan`;
            
            // Update table
            const tableBody = document.getElementById('rekap-table-body');
            
            if (kegiatanData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="border border-gray-200 px-4 py-8 text-center text-gray-500">
                            Belum ada data kegiatan. Muat data dari Google Sheets terlebih dahulu.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = kegiatanData.map(kegiatan => {
                const statusColor = {
                    'Terjadwal': 'bg-yellow-100 text-yellow-800',
                    'Berlangsung': 'bg-blue-100 text-blue-800',
                    'Selesai': 'bg-green-100 text-green-800',
                    'Dibatalkan': 'bg-red-100 text-red-800'
                }[kegiatan.status] || 'bg-gray-100 text-gray-800';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="border border-gray-200 px-4 py-3">
                            <div>
                                <p class="font-medium text-gray-800">${kegiatan.nama}</p>
                                <p class="text-sm text-gray-500">${kegiatan.kategori}</p>
                            </div>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            <p class="text-gray-700">${formatTanggal(kegiatan.tanggalMulai)}</p>
                            <p class="text-sm text-gray-500">${kegiatan.waktuMulai} - ${kegiatan.waktuSelesai}</p>
                        </td>
                        <td class="border border-gray-200 px-4 py-3 text-center">
                            <span class="font-medium text-gray-800">${kegiatan.jumlahPeserta || 0}</span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            <span class="px-2 py-1 ${statusColor} rounded-full text-xs font-medium">${kegiatan.status}</span>
                        </td>
                        <td class="border border-gray-200 px-4 py-3">
                            <button onclick="lihatDetail('${kegiatan.id}')" class="text-blue-600 hover:text-blue-800 transition-colors mr-2">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                            </button>
                            <button onclick="editKegiatan('${kegiatan.id}')" class="text-yellow-600 hover:text-yellow-800 transition-colors">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        // Update Berita Acara Filters
        function updateBeritaAcaraFilters() {
            const filterSelect = document.getElementById('filter-kegiatan-ba');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Semua Kegiatan</option>' +
                    kegiatanData.map(k => `<option value="${k.id}">${k.nama} - ${formatTanggal(k.tanggalMulai)}</option>`).join('');
            }
        }
        
        // Update Daftar Hadir Filters
        function updateDaftarHadirFilters() {
            const filterSelect = document.getElementById('filter-kegiatan-dh');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Semua Kegiatan</option>' +
                    kegiatanData.map(k => `<option value="${k.id}">${k.nama} - ${formatTanggal(k.tanggalMulai)}</option>`).join('');
            }
        }

        // Rekap functions
        function exportData() {
            console.log('Export data clicked');
            
            if (kegiatanData.length === 0) {
                showNotification('Tidak ada data untuk diekspor!', 'warning');
                return;
            }
            
            // Create CSV content
            const csvContent = [
                ['ID Kegiatan', 'Nama Kegiatan', 'Jenis', 'Kategori', 'Tanggal Mulai', 'Tanggal Selesai', 'Waktu Mulai', 'Waktu Selesai', 'Status', 'Penanggung Jawab', 'Jumlah Peserta', 'Deskripsi', 'Dokumentasi', 'Dibuat Pada'],
                ...kegiatanData.map(k => [
                    k.id, k.nama, k.jenis, k.kategori, k.tanggalMulai, k.tanggalSelesai, 
                    k.waktuMulai, k.waktuSelesai, k.status, k.penanggungJawab, k.jumlahPeserta, 
                    k.deskripsi, k.dokumentasi, new Date(k.createdAt).toLocaleString('id-ID')
                ])
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `rekap_kegiatan_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Data berhasil diekspor ke file CSV!', 'success');
        }

        function generateReport() {
            console.log('ðŸ“Š Generate report clicked');
            
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i>Generating...';
            button.disabled = true;
            
            showNotification('ðŸ“Š Membuat laporan kegiatan...', 'info');
            
            setTimeout(() => {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
                lucide.createIcons();
                
                showNotification('âœ… Laporan berhasil dibuat dan siap diunduh!', 'success');
            }, 2000);
        }

        function lihatDetail(id) {
            console.log('Lihat detail clicked, ID:', id);
            
            // Find kegiatan by ID
            const kegiatan = kegiatanData.find(k => k.id === id);
            if (!kegiatan) {
                showNotification('Data kegiatan tidak ditemukan!', 'error');
                return;
            }
            
            // Show detail modal
            showDetailModal(kegiatan);
        }
        
        // Show detail modal
        function showDetailModal(kegiatan) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'detail-modal';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            const statusColor = {
                'Terjadwal': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'Berlangsung': 'bg-blue-100 text-blue-800 border-blue-200',
                'Selesai': 'bg-green-100 text-green-800 border-green-200',
                'Dibatalkan': 'bg-red-100 text-red-800 border-red-200'
            }[kegiatan.status] || 'bg-gray-100 text-gray-800 border-gray-200';
            
            const jenisColor = {
                'Akademik': 'bg-purple-100 text-purple-800',
                'Non-Akademik': 'bg-green-100 text-green-800',
                'Kesiswaan': 'bg-blue-100 text-blue-800',
                'Manajemen': 'bg-orange-100 text-orange-800',
                'Lingkungan': 'bg-emerald-100 text-emerald-800',
                'Khusus': 'bg-red-100 text-red-800'
            }[kegiatan.jenis] || 'bg-gray-100 text-gray-800';
            
            // Format dates
            const tanggalMulaiFormatted = formatTanggal(kegiatan.tanggalMulai);
            const tanggalSelesaiFormatted = formatTanggal(kegiatan.tanggalSelesai);
            const createdAtFormatted = new Date(kegiatan.createdAt).toLocaleString('id-ID');
            
            // Photo section
            let photoSection = '';
            if (kegiatan.fotoBase64) {
                photoSection = `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">ðŸ“¸ Dokumentasi Kegiatan</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <img src="${kegiatan.fotoBase64}" alt="Dokumentasi ${kegiatan.nama}" 
                                 class="w-full max-h-64 object-cover rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow"
                                 onclick="showFullImage('${kegiatan.fotoBase64}', '${kegiatan.nama}')">
                            <p class="text-xs text-gray-500 mt-2 text-center">Klik gambar untuk melihat ukuran penuh</p>
                        </div>
                    </div>
                `;
            } else if (kegiatan.dokumentasi) {
                photoSection = `
                    <div class="mb-6">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3">ðŸ“Ž File Dokumentasi</h4>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="file-image" class="w-8 h-8 text-gray-400"></i>
                                <div>
                                    <p class="font-medium text-gray-800">${kegiatan.dokumentasi}</p>
                                    <p class="text-sm text-gray-500">File dokumentasi tersimpan</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            modalOverlay.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <!-- Header -->
                    <div class="gradient-bg p-6 text-white rounded-t-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold">Detail Kegiatan</h3>
                                <p class="text-sm opacity-90">Informasi lengkap kegiatan</p>
                            </div>
                            <button onclick="closeDetailModal()" class="text-white hover:text-gray-200 transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6">
                        <!-- Basic Info -->
                        <div class="mb-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex-1">
                                    <h4 class="text-2xl font-bold text-gray-800 mb-2">${kegiatan.nama}</h4>
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        <span class="px-3 py-1 ${jenisColor} rounded-full text-sm font-medium">${kegiatan.jenis}</span>
                                        <span class="px-3 py-1 ${statusColor} rounded-full text-sm font-medium border">${kegiatan.status}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <h5 class="font-semibold text-gray-700 mb-2">ðŸ“‹ ID Kegiatan</h5>
                                <p class="text-gray-600 font-mono">${kegiatan.id}</p>
                            </div>
                        </div>
                        
                        <!-- Details Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                            <!-- Kategori -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-blue-700 mb-2">ðŸ·ï¸ Kategori Kegiatan</h4>
                                <p class="text-blue-800 font-medium">${kegiatan.kategori}</p>
                            </div>
                            
                            <!-- Penanggung Jawab -->
                            <div class="bg-green-50 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-green-700 mb-2">ðŸ‘¤ Penanggung Jawab</h4>
                                <p class="text-green-800 font-medium">${kegiatan.penanggungJawab}</p>
                            </div>
                            
                            <!-- Jumlah Peserta -->
                            <div class="bg-indigo-50 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-indigo-700 mb-2">ðŸ‘¥ Jumlah Peserta</h4>
                                <p class="text-indigo-800 font-medium">${kegiatan.jumlahPeserta || 0} orang</p>
                            </div>
                            
                            <!-- Tanggal Mulai -->
                            <div class="bg-purple-50 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-purple-700 mb-2">ðŸ“… Tanggal Mulai</h4>
                                <p class="text-purple-800 font-medium">${tanggalMulaiFormatted}</p>
                                <p class="text-sm text-purple-600">â° ${kegiatan.waktuMulai} WIB</p>
                            </div>
                            
                            <!-- Tanggal Selesai -->
                            <div class="bg-orange-50 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-orange-700 mb-2">ðŸ“… Tanggal Selesai</h4>
                                <p class="text-orange-800 font-medium">${tanggalSelesaiFormatted}</p>
                                <p class="text-sm text-orange-600">â° ${kegiatan.waktuSelesai} WIB</p>
                            </div>
                        </div>
                        
                        <!-- Deskripsi -->
                        ${kegiatan.deskripsi ? `
                        <div class="mb-6">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">ðŸ“ Deskripsi Kegiatan</h4>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-gray-700 leading-relaxed">${kegiatan.deskripsi}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Photo/Documentation Section -->
                        ${photoSection}
                        
                        <!-- Metadata -->
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-semibold text-gray-700 mb-3">â„¹ï¸ Informasi Sistem</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-500">Dibuat pada:</span>
                                    <p class="font-medium text-gray-700">${createdAtFormatted}</p>
                                </div>
                                <div>
                                    <span class="text-gray-500">Status sinkronisasi:</span>
                                    <p class="font-medium text-green-600">âœ… Tersinkron dengan Google Sheets</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                        <button onclick="editKegiatan('${kegiatan.id}')" class="btn-warning text-white px-6 py-2 rounded-lg font-medium">
                            <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                            Edit Kegiatan
                        </button>
                        <button onclick="exportSingleKegiatan('${kegiatan.id}')" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                            <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                            Export Data
                        </button>
                        <button onclick="closeDetailModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            // Add to body
            document.body.appendChild(modalOverlay);
            
            // Initialize icons
            lucide.createIcons();
            
            // Add click outside to close
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeDetailModal();
                }
            });
            
            // Add escape key to close
            document.addEventListener('keydown', handleEscapeKey);
        }
        
        // Close detail modal
        function closeDetailModal() {
            const modal = document.getElementById('detail-modal');
            if (modal) {
                document.body.removeChild(modal);
                document.removeEventListener('keydown', handleEscapeKey);
            }
        }
        
        // Handle escape key
        function handleEscapeKey(e) {
            if (e.key === 'Escape') {
                closeDetailModal();
            }
        }
        
        // Show full image
        function showFullImage(imageSrc, title) {
            const imageModal = document.createElement('div');
            imageModal.className = 'fixed inset-0 bg-black bg-opacity-80 z-60 flex items-center justify-center p-4';
            
            imageModal.innerHTML = `
                <div class="relative max-w-4xl max-h-full">
                    <button onclick="this.parentElement.parentElement.remove()" 
                            class="absolute top-4 right-4 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2 z-10">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <img src="${imageSrc}" alt="${title}" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
                    <div class="absolute bottom-4 left-4 right-4 bg-black bg-opacity-50 text-white p-3 rounded-lg">
                        <h4 class="font-semibold">${title}</h4>
                        <p class="text-sm opacity-90">Dokumentasi Kegiatan</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(imageModal);
            lucide.createIcons();
            
            // Click outside to close
            imageModal.addEventListener('click', (e) => {
                if (e.target === imageModal) {
                    document.body.removeChild(imageModal);
                }
            });
        }
        
        // Export single kegiatan
        function exportSingleKegiatan(id) {
            const kegiatan = kegiatanData.find(k => k.id === id);
            if (!kegiatan) {
                showNotification('Data kegiatan tidak ditemukan!', 'error');
                return;
            }
            
            // Create CSV content
            const csvContent = [
                ['Field', 'Value'],
                ['ID Kegiatan', kegiatan.id],
                ['Nama Kegiatan', kegiatan.nama],
                ['Jenis Kegiatan', kegiatan.jenis],
                ['Kategori Kegiatan', kegiatan.kategori],
                ['Tanggal Mulai', kegiatan.tanggalMulai],
                ['Tanggal Selesai', kegiatan.tanggalSelesai],
                ['Waktu Mulai', kegiatan.waktuMulai],
                ['Waktu Selesai', kegiatan.waktuSelesai],
                ['Status', kegiatan.status],
                ['Penanggung Jawab', kegiatan.penanggungJawab],
                ['Jumlah Peserta', kegiatan.jumlahPeserta],
                ['Deskripsi', kegiatan.deskripsi],
                ['Dokumentasi', kegiatan.dokumentasi],
                ['Dibuat Pada', new Date(kegiatan.createdAt).toLocaleString('id-ID')]
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `kegiatan_${kegiatan.id}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification(`Data kegiatan "${kegiatan.nama}" berhasil diexport!`, 'success');
        }

        // Simpan Berita Acara Langsung (dari header button)
        function simpanBeritaAcaraLangsung() {
            if (!currentDraftBeritaAcara || !currentDraftBeritaAcaraKegiatan) {
                showNotification('âš ï¸ Tidak ada berita acara yang sedang dibuat!', 'warning');
                return;
            }
            
            // Show loading state
            const button = document.getElementById('simpan-berita-acara-btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i>Menyimpan...';
            button.disabled = true;
            
            try {
                // Save berita acara locally
                currentDraftBeritaAcara.status = 'Tersimpan';
                savedBeritaAcara.push(currentDraftBeritaAcara);
                
                // Update berita acara list
                updateBeritaAcaraList();
                
                // Send to Google Sheets
                setTimeout(async () => {
                    try {
                        const success = await kirimBeritaAcaraKeGoogleSheets(currentDraftBeritaAcara);
                        
                        if (success) {
                            showNotification(`âœ… Berita acara "${currentDraftBeritaAcaraKegiatan.nama}" berhasil disimpan dan dikirim ke Google Sheets!`, 'success');
                        } else {
                            showNotification(`âš ï¸ Berita acara disimpan lokal. Gagal mengirim ke Google Sheets.`, 'warning');
                        }
                    } catch (error) {
                        console.error('Error sending berita acara to sheets:', error);
                        showNotification(`âš ï¸ Berita acara disimpan lokal. Error: ${error.message}`, 'warning');
                    }
                }, 1000);
                
                // Clear draft
                currentDraftBeritaAcara = null;
                currentDraftBeritaAcaraKegiatan = null;
                
                // Hide save button
                button.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving berita acara:', error);
                showNotification('âŒ Gagal menyimpan berita acara!', 'error');
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
                lucide.createIcons();
            }
        }
        
        // Kirim Berita Acara ke Google Sheets
        async function kirimBeritaAcaraKeGoogleSheets(beritaAcaraData) {
            const scriptUrl = document.getElementById('script-url').value;
            
            if (!scriptUrl) {
                console.log('Script URL belum diatur');
                return false;
            }
            
            try {
                const payload = {
                    action: 'CREATE_BERITA_ACARA',
                    data: {
                        id: beritaAcaraData.id,
                        kegiatan_id: beritaAcaraData.kegiatanId,
                        nama_kegiatan: beritaAcaraData.namaKegiatan,
                        tempat_kegiatan: beritaAcaraData.tempatKegiatan,
                        pimpinan_rapat: beritaAcaraData.pimpinanRapat,
                        agenda_pembahasan: beritaAcaraData.agendaPembahasan,
                        hasil_keputusan: beritaAcaraData.hasilKeputusan,
                        notulen: beritaAcaraData.notulen,
                        moderator: beritaAcaraData.moderator,
                        catatan_tambahan: beritaAcaraData.catatanTambahan,
                        daftar_hadir_id: beritaAcaraData.daftarHadirId || '',
                        jumlah_peserta: beritaAcaraData.pesertaData ? beritaAcaraData.pesertaData.length : 0,
                        status: beritaAcaraData.status,
                        created_at: beritaAcaraData.createdAt
                    }
                };
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                return true; // Assume success for no-cors
                
            } catch (error) {
                console.error('Error sending berita acara to sheets:', error);
                return false;
            }
        }
        
        // Berita Acara Functions
        function generateBeritaAcara() {
            console.log('Generate berita acara clicked');
            
            if (kegiatanData.length === 0) {
                showNotification('Belum ada data kegiatan untuk dibuat berita acara!', 'warning');
                return;
            }
            
            // Show modal to select kegiatan
            showBeritaAcaraModal();
        }
        
        function showBeritaAcaraModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'berita-acara-modal';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            modalOverlay.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="gradient-bg p-6 text-white rounded-t-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold">Generate Berita Acara</h3>
                                <p class="text-sm opacity-90">Pilih kegiatan untuk dibuat berita acara</p>
                            </div>
                            <button onclick="closeBeritaAcaraModal()" class="text-white hover:text-gray-200 transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kegiatan</label>
                            <select id="select-kegiatan-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required>
                                <option value="">Pilih kegiatan...</option>
                                ${kegiatanData.map(k => `<option value="${k.id}">${k.nama} - ${formatTanggal(k.tanggalMulai)}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tempat Kegiatan</label>
                                <input type="text" id="tempat-kegiatan-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Contoh: Aula Sekolah" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pimpinan Rapat</label>
                                <input type="text" id="pimpinan-rapat-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Contoh: Kepala Sekolah" required>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Agenda Pembahasan</label>
                            <textarea id="agenda-pembahasan-ba" rows="4" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none" placeholder="Masukkan agenda pembahasan kegiatan..."></textarea>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hasil Keputusan</label>
                            <textarea id="hasil-keputusan-ba" rows="4" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none" placeholder="Masukkan hasil keputusan atau kesimpulan..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notulen Rapat</label>
                                <input type="text" id="notulen-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Nama notulen rapat">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Moderator</label>
                                <input type="text" id="moderator-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Nama moderator">
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Tambahan</label>
                            <textarea id="catatan-tambahan-ba" rows="3" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none" placeholder="Catatan atau informasi tambahan..."></textarea>
                        </div>
                        
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                            <button onclick="createBeritaAcara()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                                <i data-lucide="file-plus" class="w-4 h-4 inline mr-2"></i>
                                Buat Berita Acara
                            </button>
                            <button onclick="closeBeritaAcaraModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            lucide.createIcons();
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeBeritaAcaraModal();
                }
            });
        }
        
        function closeBeritaAcaraModal() {
            const modal = document.getElementById('berita-acara-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function createBeritaAcara() {
            const kegiatanId = document.getElementById('select-kegiatan-ba').value;
            const tempatKegiatan = document.getElementById('tempat-kegiatan-ba').value;
            const pimpinanRapat = document.getElementById('pimpinan-rapat-ba').value;
            const agendaPembahasan = document.getElementById('agenda-pembahasan-ba').value;
            const hasilKeputusan = document.getElementById('hasil-keputusan-ba').value;
            const notulen = document.getElementById('notulen-ba').value;
            const moderator = document.getElementById('moderator-ba').value;
            const catatanTambahan = document.getElementById('catatan-tambahan-ba').value;
            
            if (!kegiatanId || !tempatKegiatan || !pimpinanRapat) {
                showNotification('Mohon lengkapi semua field yang wajib diisi!', 'warning');
                return;
            }
            
            const kegiatan = kegiatanData.find(k => k.id === kegiatanId);
            if (!kegiatan) {
                showNotification('Kegiatan tidak ditemukan!', 'error');
                return;
            }
            
            // Create berita acara data object
            const beritaAcaraData = {
                id: 'BA' + Date.now(),
                kegiatanId: kegiatanId,
                namaKegiatan: kegiatan.nama,
                tempatKegiatan: tempatKegiatan,
                pimpinanRapat: pimpinanRapat,
                agendaPembahasan: agendaPembahasan,
                hasilKeputusan: hasilKeputusan,
                notulen: notulen,
                moderator: moderator,
                catatanTambahan: catatanTambahan,
                createdAt: new Date().toISOString(),
                status: 'Draft'
            };
            
            // Generate berita acara content
            const beritaAcaraContent = generateBeritaAcaraContent(kegiatan, beritaAcaraData);
            
            // Store as current draft
            currentDraftBeritaAcara = beritaAcaraData;
            currentDraftBeritaAcaraKegiatan = kegiatan;
            
            // Show save button in header
            const saveButton = document.getElementById('simpan-berita-acara-btn');
            if (saveButton) {
                saveButton.classList.remove('hidden');
            }
            
            // Show preview modal with save option
            showBeritaAcaraPreview(beritaAcaraContent, kegiatan, beritaAcaraData);
            closeBeritaAcaraModal();
        }
        
        // Generate Berita Acara Content with Participants
        function generateBeritaAcaraContentWithParticipants(kegiatan, beritaAcaraData) {
            const tanggalKegiatan = formatTanggal(kegiatan.tanggalMulai);
            const waktuKegiatan = `${kegiatan.waktuMulai} - ${kegiatan.waktuSelesai} WIB`;
            
            // Generate participant list
            let participantSection = '';
            if (beritaAcaraData.pesertaData && beritaAcaraData.pesertaData.length > 0) {
                const participantList = beritaAcaraData.pesertaData.map((peserta, index) => {
                    let info = `${index + 1}. ${peserta.nama}`;
                    if (peserta.jabatan) info += ` (${peserta.jabatan})`;
                    if (peserta.nip) info += ` - NIP: ${peserta.nip}`;
                    if (peserta.mapel) info += ` - ${peserta.mapel}`;
                    if (peserta.kelas) info += ` - ${peserta.kelas}`;
                    if (peserta.instansi) info += ` - ${peserta.instansi}`;
                    return info;
                }).join('<br>');
                
                participantSection = `
                    <!-- Daftar Peserta -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3">DAFTAR PESERTA RAPAT</h3>
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-justify leading-relaxed">${participantList}</p>
                        </div>
                        <p class="text-sm text-gray-600 mt-2 italic">
                            Total peserta: ${beritaAcaraData.pesertaData.length} orang
                            ${beritaAcaraData.daftarHadirId ? ` (Data dari Daftar Hadir: ${beritaAcaraData.daftarHadirId})` : ''}
                        </p>
                    </div>
                `;
            }
            
            return `
                <div class="print-page">
                    <!-- Header Document -->
                    <div class="print-header text-center mb-8">
                        <h1 class="text-2xl font-bold mb-2">BERITA ACARA KEGIATAN</h1>
                        <h2 class="text-lg font-semibold text-gray-700">${kegiatan.nama}</h2>
                        <div class="border-b-2 border-gray-800 mt-4"></div>
                    </div>
                    
                    <!-- Document Info -->
                    <div class="mb-6">
                        <table class="w-full text-sm">
                            <tr>
                                <td class="py-1 w-32 font-medium">Nomor BA</td>
                                <td class="py-1 w-4">:</td>
                                <td class="py-1">${beritaAcaraData.id}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Hari/Tanggal</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${tanggalKegiatan}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Waktu</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${waktuKegiatan}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Tempat</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${beritaAcaraData.tempatKegiatan}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Pimpinan Rapat</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${beritaAcaraData.pimpinanRapat}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Notulen</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${beritaAcaraData.notulen || '-'}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Moderator</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${beritaAcaraData.moderator || '-'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    ${participantSection}
                    
                    <!-- Agenda Pembahasan -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3">AGENDA PEMBAHASAN</h3>
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-justify leading-relaxed">${beritaAcaraData.agendaPembahasan || 'Pembahasan mengenai ' + kegiatan.nama + ' yang dilaksanakan pada ' + tanggalKegiatan + '.'}</p>
                        </div>
                    </div>
                    
                    <!-- Hasil Keputusan -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3">HASIL KEPUTUSAN</h3>
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-justify leading-relaxed">${beritaAcaraData.hasilKeputusan || 'Kegiatan ' + kegiatan.nama + ' telah dilaksanakan dengan baik dan sesuai dengan rencana yang telah ditetapkan.'}</p>
                        </div>
                    </div>
                    
                    <!-- Catatan Tambahan -->
                    ${beritaAcaraData.catatanTambahan ? `
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3">CATATAN TAMBAHAN</h3>
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-justify leading-relaxed">${beritaAcaraData.catatanTambahan}</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Penutup -->
                    <div class="mb-8">
                        <p class="text-justify">Demikian berita acara ini dibuat dengan sebenarnya untuk dapat dipergunakan sebagaimana mestinya.</p>
                    </div>
                    
                    <!-- Tanda Tangan -->
                    <div class="grid grid-cols-2 gap-8 mt-12">
                        <div class="text-center">
                            <p class="mb-16">Notulen,</p>
                            <div class="border-b border-gray-800 mb-2"></div>
                            <p class="font-medium">${beritaAcaraData.notulen || '(...........................)'}</p>
                        </div>
                        <div class="text-center">
                            <p class="mb-16">Pimpinan Rapat,</p>
                            <div class="border-b border-gray-800 mb-2"></div>
                            <p class="font-medium">${beritaAcaraData.pimpinanRapat}</p>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="text-center mt-8 text-sm text-gray-600">
                        <p>Dibuat pada: ${new Date(beritaAcaraData.createdAt).toLocaleString('id-ID')}</p>
                        <p>ID Dokumen: ${beritaAcaraData.id}</p>
                        ${beritaAcaraData.daftarHadirId ? `<p>Referensi Daftar Hadir: ${beritaAcaraData.daftarHadirId}</p>` : ''}
                    </div>
                </div>
            `;
        }
        
        // Generate Berita Acara Content
        function generateBeritaAcaraContent(kegiatan, beritaAcaraData) {
            const tanggalKegiatan = formatTanggal(kegiatan.tanggalMulai);
            const waktuKegiatan = `${kegiatan.waktuMulai} - ${kegiatan.waktuSelesai} WIB`;
            
            return `
                <div class="print-page">
                    <!-- Header Document -->
                    <div class="print-header text-center mb-8">
                        <h1 class="text-2xl font-bold mb-2">BERITA ACARA KEGIATAN</h1>
                        <h2 class="text-lg font-semibold text-gray-700">${kegiatan.nama}</h2>
                        <div class="border-b-2 border-gray-800 mt-4"></div>
                    </div>
                    
                    <!-- Document Info -->
                    <div class="mb-6">
                        <table class="w-full text-sm">
                            <tr>
                                <td class="py-1 w-32 font-medium">Nomor BA</td>
                                <td class="py-1 w-4">:</td>
                                <td class="py-1">${beritaAcaraData.id}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Hari/Tanggal</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${tanggalKegiatan}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Waktu</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${waktuKegiatan}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Tempat</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${beritaAcaraData.tempatKegiatan}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Pimpinan Rapat</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${beritaAcaraData.pimpinanRapat}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Notulen</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${beritaAcaraData.notulen || '-'}</td>
                            </tr>
                            <tr>
                                <td class="py-1 font-medium">Moderator</td>
                                <td class="py-1">:</td>
                                <td class="py-1">${beritaAcaraData.moderator || '-'}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Agenda Pembahasan -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3">AGENDA PEMBAHASAN</h3>
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-justify leading-relaxed">${beritaAcaraData.agendaPembahasan || 'Pembahasan mengenai ' + kegiatan.nama + ' yang dilaksanakan pada ' + tanggalKegiatan + '.'}</p>
                        </div>
                    </div>
                    
                    <!-- Hasil Keputusan -->
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3">HASIL KEPUTUSAN</h3>
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-justify leading-relaxed">${beritaAcaraData.hasilKeputusan || 'Kegiatan ' + kegiatan.nama + ' telah dilaksanakan dengan baik dan sesuai dengan rencana yang telah ditetapkan.'}</p>
                        </div>
                    </div>
                    
                    <!-- Catatan Tambahan -->
                    ${beritaAcaraData.catatanTambahan ? `
                    <div class="mb-6">
                        <h3 class="text-lg font-bold mb-3">CATATAN TAMBAHAN</h3>
                        <div class="bg-gray-50 p-4 rounded border">
                            <p class="text-justify leading-relaxed">${beritaAcaraData.catatanTambahan}</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Penutup -->
                    <div class="mb-8">
                        <p class="text-justify">Demikian berita acara ini dibuat dengan sebenarnya untuk dapat dipergunakan sebagaimana mestinya.</p>
                    </div>
                    
                    <!-- Tanda Tangan -->
                    <div class="grid grid-cols-2 gap-8 mt-12">
                        <div class="text-center">
                            <p class="mb-16">Notulen,</p>
                            <div class="border-b border-gray-800 mb-2"></div>
                            <p class="font-medium">${beritaAcaraData.notulen || '(...........................)'}</p>
                        </div>
                        <div class="text-center">
                            <p class="mb-16">Pimpinan Rapat,</p>
                            <div class="border-b border-gray-800 mb-2"></div>
                            <p class="font-medium">${beritaAcaraData.pimpinanRapat}</p>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="text-center mt-8 text-sm text-gray-600">
                        <p>Dibuat pada: ${new Date(beritaAcaraData.createdAt).toLocaleString('id-ID')}</p>
                        <p>ID Dokumen: ${beritaAcaraData.id}</p>
                    </div>
                </div>
            `;
        }
        
        // Show Berita Acara Preview
        function showBeritaAcaraPreview(content, kegiatan, beritaAcaraData) {
            const previewModal = document.createElement('div');
            previewModal.id = 'berita-acara-preview';
            previewModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            previewModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                    <!-- Header -->
                    <div class="gradient-bg p-4 text-white rounded-t-xl flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold">Preview Berita Acara</h3>
                            <p class="text-sm opacity-90">${kegiatan.nama}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="printBeritaAcara()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                Print
                            </button>
                            <button onclick="downloadBeritaAcaraPDF('${beritaAcaraData.id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Download
                            </button>
                            <button onclick="closeBeritaAcaraPreview()" class="text-white hover:text-gray-200 transition-colors p-2">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                        <div id="berita-acara-content" class="bg-white p-8 rounded-lg shadow-sm max-w-4xl mx-auto">
                            ${content}
                        </div>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                        <button onclick="saveBeritaAcara('${JSON.stringify(beritaAcaraData).replace(/'/g, "\\'")}', '${JSON.stringify(kegiatan).replace(/'/g, "\\'")}', '${content.replace(/'/g, "\\'")}', '${beritaAcaraData.id}')" class="btn-success text-white px-6 py-2 rounded-lg font-medium">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Simpan Berita Acara
                        </button>
                        <button onclick="editBeritaAcara('${beritaAcaraData.id}')" class="btn-warning text-white px-6 py-2 rounded-lg font-medium">
                            <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                            Edit
                        </button>
                        <button onclick="closeBeritaAcaraPreview()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewModal);
            lucide.createIcons();
        }
        
        // Close Berita Acara Preview
        function closeBeritaAcaraPreview() {
            const modal = document.getElementById('berita-acara-preview');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // Save Berita Acara
        function saveBeritaAcara(beritaAcaraDataStr, kegiatanStr, content, id) {
            try {
                const beritaAcaraData = JSON.parse(beritaAcaraDataStr);
                const kegiatan = JSON.parse(kegiatanStr);
                
                // Add to saved berita acara
                beritaAcaraData.content = content;
                beritaAcaraData.status = 'Tersimpan';
                savedBeritaAcara.push(beritaAcaraData);
                
                // Update berita acara list
                updateBeritaAcaraList();
                
                // Close preview
                closeBeritaAcaraPreview();
                
                showNotification(`Berita Acara "${kegiatan.nama}" berhasil disimpan!`, 'success');
                
            } catch (error) {
                console.error('Error saving berita acara:', error);
                showNotification('Gagal menyimpan berita acara!', 'error');
            }
        }
        
        // Print Berita Acara
        function printBeritaAcara() {
            const content = document.getElementById('berita-acara-content').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Berita Acara Kegiatan</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; }
                        td { padding: 5px 0; }
                        .bg-gray-50 { background-color: #f9f9f9; padding: 15px; border: 1px solid #ddd; }
                        .grid { display: grid; }
                        .grid-cols-2 { grid-template-columns: 1fr 1fr; }
                        .gap-8 { gap: 2rem; }
                        .text-center { text-align: center; }
                        .border-b { border-bottom: 1px solid #000; }
                        .mb-16 { margin-bottom: 4rem; }
                        .mb-2 { margin-bottom: 0.5rem; }
                        .font-medium { font-weight: 500; }
                        .text-justify { text-align: justify; }
                        .leading-relaxed { line-height: 1.625; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
            
            showNotification('Dokumen siap untuk dicetak!', 'success');
        }
        
        // Download Berita Acara PDF
        function downloadBeritaAcaraPDF(id) {
            showNotification('Fitur download PDF akan segera tersedia!', 'info');
        }
        
        // Update Berita Acara List
        function updateBeritaAcaraList() {
            const container = document.getElementById('berita-acara-list');
            
            if (savedBeritaAcara.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="file-text" class="w-20 h-20 text-gray-300 mx-auto mb-4"></i>
                        <h4 class="text-lg font-semibold text-gray-600 mb-2">Belum Ada Berita Acara</h4>
                        <p class="text-gray-500 mb-4">Generate berita acara otomatis dari kegiatan yang sudah ada</p>
                        <button onclick="generateBeritaAcara()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                            <i data-lucide="file-plus" class="w-4 h-4 inline mr-2"></i>
                            Generate Berita Acara
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = savedBeritaAcara.map(ba => {
                const kegiatan = kegiatanData.find(k => k.id === ba.kegiatanId);
                const statusColor = {
                    'Draft': 'bg-yellow-100 text-yellow-800',
                    'Tersimpan': 'bg-green-100 text-green-800',
                    'Dikirim': 'bg-blue-100 text-blue-800'
                }[ba.status] || 'bg-gray-100 text-gray-800';
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">${ba.namaKegiatan}</h4>
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="px-3 py-1 ${statusColor} rounded-full text-sm font-medium">${ba.status}</span>
                                    <span class="text-sm text-gray-500">ID: ${ba.id}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm">
                            <div>
                                <span class="text-gray-500">Tempat:</span>
                                <p class="font-medium text-gray-700">${ba.tempatKegiatan}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Pimpinan Rapat:</span>
                                <p class="font-medium text-gray-700">${ba.pimpinanRapat}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Notulen:</span>
                                <p class="font-medium text-gray-700">${ba.notulen || '-'}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Dibuat:</span>
                                <p class="font-medium text-gray-700">${new Date(ba.createdAt).toLocaleDateString('id-ID')}</p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                            <button onclick="previewBeritaAcara('${ba.id}')" class="btn-primary text-white px-4 py-2 rounded-lg font-medium text-sm">
                                <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                                Preview
                            </button>
                            <button onclick="printSavedBeritaAcara('${ba.id}')" class="btn-success text-white px-4 py-2 rounded-lg font-medium text-sm">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                Print
                            </button>
                            <button onclick="editBeritaAcara('${ba.id}')" class="btn-warning text-white px-4 py-2 rounded-lg font-medium text-sm">
                                <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                                Edit
                            </button>
                            <button onclick="hapusBeritaAcara('${ba.id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                                Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        // Preview Saved Berita Acara
        function previewBeritaAcara(id) {
            const ba = savedBeritaAcara.find(b => b.id === id);
            if (!ba) {
                showNotification('Berita acara tidak ditemukan!', 'error');
                return;
            }
            
            const kegiatan = kegiatanData.find(k => k.id === ba.kegiatanId);
            showBeritaAcaraPreview(ba.content, kegiatan, ba);
        }
        
        // Print Saved Berita Acara
        function printSavedBeritaAcara(id) {
            const ba = savedBeritaAcara.find(b => b.id === id);
            if (!ba) {
                showNotification('Berita acara tidak ditemukan!', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Berita Acara - ${ba.namaKegiatan}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
                        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; }
                        td { padding: 5px 0; }
                        .bg-gray-50 { background-color: #f9f9f9; padding: 15px; border: 1px solid #ddd; }
                        .grid { display: grid; }
                        .grid-cols-2 { grid-template-columns: 1fr 1fr; }
                        .gap-8 { gap: 2rem; }
                        .text-center { text-align: center; }
                        .border-b { border-bottom: 1px solid #000; }
                        .mb-16 { margin-bottom: 4rem; }
                        .mb-2 { margin-bottom: 0.5rem; }
                        .font-medium { font-weight: 500; }
                        .text-justify { text-align: justify; }
                        .leading-relaxed { line-height: 1.625; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${ba.content}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
            
            showNotification(`Berita Acara "${ba.namaKegiatan}" siap untuk dicetak!`, 'success');
        }
        
        // Edit Berita Acara
        function editBeritaAcara(id) {
            showNotification(`Edit berita acara dengan ID: ${id}`, 'info');
        }
        
        // Hapus Berita Acara
        function hapusBeritaAcara(id) {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            confirmModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="text-center">
                        <i data-lucide="trash-2" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Hapus Berita Acara</h3>
                        <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus berita acara ini?</p>
                        
                        <div class="flex space-x-4">
                            <button onclick="confirmHapusBeritaAcara('${id}'); this.parentElement.parentElement.parentElement.parentElement.remove();" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Ya, Hapus
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove();" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            lucide.createIcons();
        }
        
        function confirmHapusBeritaAcara(id) {
            const index = savedBeritaAcara.findIndex(ba => ba.id === id);
            if (index !== -1) {
                savedBeritaAcara.splice(index, 1);
                updateBeritaAcaraList();
                showNotification(`Berita acara berhasil dihapus!`, 'success');
            }
        }
        
        // Download All Berita Acara
        function downloadAllBeritaAcara() {
            if (savedBeritaAcara.length === 0) {
                showNotification('Belum ada berita acara untuk diunduh!', 'warning');
                return;
            }
            
            showNotification(`Mengunduh ${savedBeritaAcara.length} berita acara...`, 'info');
            
            // Create ZIP-like structure (simplified)
            setTimeout(() => {
                showNotification('Semua berita acara berhasil diunduh!', 'success');
            }, 2000);
        }
        
        // Filter Berita Acara
        function filterBeritaAcara() {
            // Implementation for filtering berita acara
            console.log('Filter berita acara');
        }

        // ===== DAFTAR HADIR FUNCTIONS =====
        
        // Global variables untuk daftar hadir sementara
        let currentDraftDaftarHadir = null;
        let currentDraftKegiatan = null;
        
        // Global variables untuk berita acara sementara
        let currentDraftBeritaAcara = null;
        let currentDraftBeritaAcaraKegiatan = null;
        
        // Template data guru/staff untuk import
        const templateGuruStaff = [
            { nama: 'Dr. Ahmad Suryadi, M.Pd', jabatan: 'Kepala Sekolah', nip: '196501011990031001', mapel: 'Manajemen Pendidikan' },
            { nama: 'Siti Nurhaliza, S.Pd', jabatan: 'Wakil Kepala Sekolah', nip: '197203151998032002', mapel: 'Bahasa Indonesia' },
            { nama: 'Budi Santoso, S.Pd', jabatan: 'Guru', nip: '198005102005011003', mapel: 'Matematika' },
            { nama: 'Rina Kartika, S.Pd', jabatan: 'Guru', nip: '198507252010012004', mapel: 'Bahasa Inggris' },
            { nama: 'Muhammad Rizki, S.Pd', jabatan: 'Guru', nip: '199001152015031005', mapel: 'IPA' },
            { nama: 'Dewi Sartika, S.Pd', jabatan: 'Guru', nip: '198803202012012006', mapel: 'IPS' },
            { nama: 'Agus Prasetyo, S.Pd', jabatan: 'Guru', nip: '197912102008011007', mapel: 'Pendidikan Jasmani' },
            { nama: 'Lestari Wulandari, S.Pd', jabatan: 'Guru', nip: '198406152009012008', mapel: 'Seni Budaya' },
            { nama: 'Hendra Wijaya, S.Kom', jabatan: 'Guru', nip: '199205102017031009', mapel: 'TIK' },
            { nama: 'Fatimah Azzahra, S.Pd', jabatan: 'Guru BK', nip: '198909252014012010', mapel: 'Bimbingan Konseling' }
        ];
        
        // Fungsi untuk menambah peserta baru
        function tambahPesertaDH() {
            const container = document.getElementById('daftar-peserta-container');
            const emptyMessage = document.getElementById('empty-peserta-message');
            
            // Hide empty message
            if (emptyMessage) {
                emptyMessage.style.display = 'none';
            }
            
            const pesertaId = 'peserta_' + Date.now();
            const format = document.getElementById('format-dh-modal').value || 'standard';
            
            let inputFields = '';
            
            switch (format) {
                case 'lengkap':
                    inputFields = `
                        <input type="text" placeholder="Nama Lengkap" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm" data-field="nama" required>
                        <input type="text" placeholder="Jabatan" class="w-32 px-3 py-2 border border-gray-300 rounded text-sm" data-field="jabatan">
                        <input type="text" placeholder="Instansi" class="w-32 px-3 py-2 border border-gray-300 rounded text-sm" data-field="instansi">
                    `;
                    break;
                case 'siswa':
                    inputFields = `
                        <input type="text" placeholder="Nama Lengkap" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm" data-field="nama" required>
                        <input type="text" placeholder="Kelas" class="w-24 px-3 py-2 border border-gray-300 rounded text-sm" data-field="kelas">
                    `;
                    break;
                case 'guru':
                    inputFields = `
                        <input type="text" placeholder="Nama Lengkap" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm" data-field="nama" required>
                        <input type="text" placeholder="NIP" class="w-32 px-3 py-2 border border-gray-300 rounded text-sm" data-field="nip">
                        <input type="text" placeholder="Mata Pelajaran" class="w-32 px-3 py-2 border border-gray-300 rounded text-sm" data-field="mapel">
                    `;
                    break;
                default: // standard
                    inputFields = `
                        <input type="text" placeholder="Nama Lengkap" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm" data-field="nama" required>
                    `;
            }
            
            const pesertaElement = document.createElement('div');
            pesertaElement.id = pesertaId;
            pesertaElement.className = 'flex items-center space-x-2 bg-gray-50 p-2 rounded';
            pesertaElement.innerHTML = `
                <span class="text-sm font-medium text-gray-600 w-8">${container.children.length}</span>
                ${inputFields}
                <button type="button" onclick="hapusPesertaDH('${pesertaId}')" class="text-red-500 hover:text-red-700 p-1">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            
            container.appendChild(pesertaElement);
            lucide.createIcons();
            
            // Focus on first input
            const firstInput = pesertaElement.querySelector('input');
            if (firstInput) {
                firstInput.focus();
            }
        }
        
        // Fungsi untuk menghapus peserta
        function hapusPesertaDH(pesertaId) {
            const element = document.getElementById(pesertaId);
            if (element) {
                element.remove();
                updatePesertaNumbers();
                
                // Show empty message if no participants
                const container = document.getElementById('daftar-peserta-container');
                const emptyMessage = document.getElementById('empty-peserta-message');
                
                if (container.children.length === 1 && emptyMessage) { // Only empty message left
                    emptyMessage.style.display = 'block';
                }
            }
        }
        
        // Update nomor urut peserta
        function updatePesertaNumbers() {
            const container = document.getElementById('daftar-peserta-container');
            const pesertaElements = Array.from(container.children).filter(child => child.id !== 'empty-peserta-message');
            
            pesertaElements.forEach((element, index) => {
                const numberSpan = element.querySelector('span');
                if (numberSpan) {
                    numberSpan.textContent = index + 1;
                }
            });
        }
        
        // Import peserta dari template guru
        function importPesertaFromTemplate() {
            const format = document.getElementById('format-dh-modal').value || 'standard';
            
            if (format !== 'guru' && format !== 'lengkap') {
                showNotification('âš ï¸ Import template hanya tersedia untuk format Guru atau Lengkap', 'warning');
                return;
            }
            
            // Clear existing participants
            clearAllPeserta();
            
            // Add template participants
            templateGuruStaff.forEach(guru => {
                tambahPesertaDH();
                
                // Fill the last added participant with template data
                const container = document.getElementById('daftar-peserta-container');
                const lastPeserta = Array.from(container.children).filter(child => child.id !== 'empty-peserta-message').pop();
                
                if (lastPeserta) {
                    const namaInput = lastPeserta.querySelector('[data-field="nama"]');
                    const nipInput = lastPeserta.querySelector('[data-field="nip"]');
                    const mapelInput = lastPeserta.querySelector('[data-field="mapel"]');
                    const jabatanInput = lastPeserta.querySelector('[data-field="jabatan"]');
                    const instansiInput = lastPeserta.querySelector('[data-field="instansi"]');
                    
                    if (namaInput) namaInput.value = guru.nama;
                    if (nipInput) nipInput.value = guru.nip;
                    if (mapelInput) mapelInput.value = guru.mapel;
                    if (jabatanInput) jabatanInput.value = guru.jabatan;
                    if (instansiInput) instansiInput.value = 'SMA Negeri 1 Contoh';
                }
            });
            
            showNotification(`âœ… ${templateGuruStaff.length} template guru berhasil diimport!`, 'success');
        }
        
        // Hapus semua peserta
        function clearAllPeserta() {
            const container = document.getElementById('daftar-peserta-container');
            const emptyMessage = document.getElementById('empty-peserta-message');
            
            // Remove all participant elements except empty message
            Array.from(container.children).forEach(child => {
                if (child.id !== 'empty-peserta-message') {
                    child.remove();
                }
            });
            
            // Show empty message
            if (emptyMessage) {
                emptyMessage.style.display = 'block';
            }
        }
        
        // Ambil data peserta dari form
        function getPesertaData() {
            const container = document.getElementById('daftar-peserta-container');
            const pesertaElements = Array.from(container.children).filter(child => child.id !== 'empty-peserta-message');
            const format = document.getElementById('format-dh-modal').value || 'standard';
            
            return pesertaElements.map((element, index) => {
                const data = { no: index + 1 };
                
                const inputs = element.querySelectorAll('input[data-field]');
                inputs.forEach(input => {
                    const field = input.getAttribute('data-field');
                    data[field] = input.value.trim();
                });
                
                return data;
            }).filter(peserta => peserta.nama); // Only include participants with names
        }
        
        // Generate Daftar Hadir
        function generateDaftarHadir() {
            console.log('Generate daftar hadir clicked');
            
            if (kegiatanData.length === 0) {
                showNotification('Belum ada data kegiatan untuk dibuat daftar hadir!', 'warning');
                return;
            }
            
            // Show modal to select kegiatan and format
            showDaftarHadirModal();
        }
        
        function showDaftarHadirModal() {
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'daftar-hadir-modal';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            modalOverlay.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="gradient-bg p-6 text-white rounded-t-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold">Generate Daftar Hadir</h3>
                                <p class="text-sm opacity-90">Buat template daftar hadir untuk kegiatan</p>
                            </div>
                            <button onclick="closeDaftarHadirModal()" class="text-white hover:text-gray-200 transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Kegiatan</label>
                                <select id="select-kegiatan-dh" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required>
                                    <option value="">Pilih kegiatan...</option>
                                    ${kegiatanData.map(k => `<option value="${k.id}">${k.nama} - ${formatTanggal(k.tanggalMulai)}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Format Daftar Hadir</label>
                                <select id="format-dh-modal" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" required>
                                    <option value="standard">Standard (No, Nama, TTD)</option>
                                    <option value="lengkap">Lengkap (No, Nama, Jabatan, Instansi, TTD)</option>
                                    <option value="siswa">Siswa (No, Nama, Kelas, TTD)</option>
                                    <option value="guru">Guru (No, Nama, NIP, Mata Pelajaran, TTD)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Baris</label>
                                <input type="number" id="jumlah-baris-modal" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" value="30" min="10" max="100" required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Orientasi Halaman</label>
                                <select id="orientasi-halaman" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                                    <option value="portrait">Portrait (Tegak)</option>
                                    <option value="landscape">Landscape (Mendatar)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ukuran Font</label>
                                <select id="ukuran-font" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none">
                                    <option value="small">Kecil (10pt)</option>
                                    <option value="medium" selected>Sedang (12pt)</option>
                                    <option value="large">Besar (14pt)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Input Peserta -->
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <label class="block text-sm font-medium text-gray-700">Daftar Peserta</label>
                                <button type="button" onclick="tambahPesertaDH()" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded transition-colors">
                                    <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
                                    Tambah Peserta
                                </button>
                            </div>
                            <div id="daftar-peserta-container" class="space-y-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                <div class="text-center text-gray-500 py-4" id="empty-peserta-message">
                                    <p class="text-sm">Belum ada peserta. Klik "Tambah Peserta" untuk menambah.</p>
                                </div>
                            </div>
                            <div class="mt-2 flex space-x-2">
                                <button type="button" onclick="importPesertaFromTemplate()" class="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition-colors">
                                    ðŸ“‹ Import Template Guru
                                </button>
                                <button type="button" onclick="clearAllPeserta()" class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition-colors">
                                    ðŸ—‘ï¸ Hapus Semua
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Tambahan (Opsional)</label>
                            <textarea id="catatan-dh" rows="3" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none" placeholder="Contoh: Harap mengisi dengan lengkap dan jelas"></textarea>
                        </div>
                        
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                            <button onclick="createDaftarHadir()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                                <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i>
                                Buat Daftar Hadir
                            </button>
                            <button onclick="closeDaftarHadirModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            lucide.createIcons();
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeDaftarHadirModal();
                }
            });
        }
        
        function closeDaftarHadirModal() {
            const modal = document.getElementById('daftar-hadir-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function createDaftarHadir() {
            const kegiatanId = document.getElementById('select-kegiatan-dh').value;
            const format = document.getElementById('format-dh-modal').value;
            const jumlahBaris = parseInt(document.getElementById('jumlah-baris-modal').value);
            const orientasi = document.getElementById('orientasi-halaman').value;
            const ukuranFont = document.getElementById('ukuran-font').value;
            const catatan = document.getElementById('catatan-dh').value;
            
            if (!kegiatanId || !format || !jumlahBaris) {
                showNotification('Mohon lengkapi semua field yang wajib diisi!', 'warning');
                return;
            }
            
            const kegiatan = kegiatanData.find(k => k.id === kegiatanId);
            if (!kegiatan) {
                showNotification('Kegiatan tidak ditemukan!', 'error');
                return;
            }
            
            // Get participant data
            const pesertaData = getPesertaData();
            
            // Create daftar hadir data object
            const daftarHadirData = {
                id: 'DH' + Date.now(),
                kegiatanId: kegiatanId,
                namaKegiatan: kegiatan.nama,
                format: format,
                jumlahBaris: jumlahBaris,
                orientasi: orientasi,
                ukuranFont: ukuranFont,
                catatan: catatan,
                pesertaData: pesertaData, // Include participant data
                createdAt: new Date().toISOString(),
                status: 'Draft'
            };
            
            // Generate daftar hadir content
            const daftarHadirContent = generateDaftarHadirContent(kegiatan, daftarHadirData);
            
            // Store as current draft
            currentDraftDaftarHadir = daftarHadirData;
            currentDraftKegiatan = kegiatan;
            
            // Show save button in header
            const saveButton = document.getElementById('simpan-daftar-hadir-btn');
            if (saveButton) {
                saveButton.classList.remove('hidden');
            }
            
            // Show preview modal with save option
            showDaftarHadirPreview(daftarHadirContent, kegiatan, daftarHadirData);
            closeDaftarHadirModal();
        }
        
        // Generate Daftar Hadir Content
        function generateDaftarHadirContent(kegiatan, daftarHadirData) {
            const tanggalKegiatan = formatTanggal(kegiatan.tanggalMulai);
            const waktuKegiatan = `${kegiatan.waktuMulai} - ${kegiatan.waktuSelesai} WIB`;
            
            // Font size mapping
            const fontSizes = {
                'small': { title: '16px', header: '12px', content: '10px' },
                'medium': { title: '18px', header: '14px', content: '12px' },
                'large': { title: '20px', header: '16px', content: '14px' }
            };
            
            const fontSize = fontSizes[daftarHadirData.ukuranFont] || fontSizes.medium;
            
            // Column headers based on format
            const formatHeaders = {
                'standard': ['No', 'Nama Lengkap', 'Tanda Tangan'],
                'lengkap': ['No', 'Nama Lengkap', 'Jabatan', 'Instansi', 'Tanda Tangan'],
                'siswa': ['No', 'Nama Lengkap', 'Kelas', 'Tanda Tangan'],
                'guru': ['No', 'Nama Lengkap', 'NIP', 'Mata Pelajaran', 'Tanda Tangan']
            };
            
            const headers = formatHeaders[daftarHadirData.format] || formatHeaders.standard;
            const colCount = headers.length;
            
            // Generate table rows with participant data
            let tableRows = '';
            const pesertaData = daftarHadirData.pesertaData || [];
            const totalRows = Math.max(daftarHadirData.jumlahBaris, pesertaData.length + 5); // Ensure minimum rows
            
            for (let i = 1; i <= totalRows; i++) {
                const peserta = pesertaData[i - 1]; // Get participant data if exists
                
                let rowContent = `<td style="border: 1px solid #000; padding: 8px; text-align: center; font-size: ${fontSize.content};">${i}</td>`;
                
                // Fill data based on format
                switch (daftarHadirData.format) {
                    case 'lengkap':
                        rowContent += `
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};">${peserta?.nama || ''}</td>
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};">${peserta?.jabatan || ''}</td>
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};">${peserta?.instansi || ''}</td>
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};"></td>
                        `;
                        break;
                    case 'siswa':
                        rowContent += `
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};">${peserta?.nama || ''}</td>
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};">${peserta?.kelas || ''}</td>
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};"></td>
                        `;
                        break;
                    case 'guru':
                        rowContent += `
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};">${peserta?.nama || ''}</td>
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};">${peserta?.nip || ''}</td>
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};">${peserta?.mapel || ''}</td>
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};"></td>
                        `;
                        break;
                    default: // standard
                        rowContent += `
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};">${peserta?.nama || ''}</td>
                            <td style="border: 1px solid #000; padding: 8px; font-size: ${fontSize.content};"></td>
                        `;
                }
                
                tableRows += `<tr style="height: 40px;">${rowContent}</tr>`;
            }
            
            return `
                <div class="print-page" style="font-family: Arial, sans-serif; ${daftarHadirData.orientasi === 'landscape' ? 'width: 100%; max-width: 1000px;' : 'width: 100%; max-width: 700px;'}">
                    <!-- Header Document -->
                    <div class="print-header" style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px;">
                        <h1 style="font-size: ${fontSize.title}; font-weight: bold; margin: 0 0 10px 0;">DAFTAR HADIR KEGIATAN</h1>
                        <h2 style="font-size: ${fontSize.header}; font-weight: 600; color: #333; margin: 0;">${kegiatan.nama}</h2>
                    </div>
                    
                    <!-- Document Info -->
                    <div style="margin-bottom: 25px;">
                        <table style="width: 100%; font-size: ${fontSize.content};">
                            <tr>
                                <td style="padding: 3px 0; width: 120px; font-weight: 500;">Hari/Tanggal</td>
                                <td style="padding: 3px 0; width: 10px;">:</td>
                                <td style="padding: 3px 0;">${tanggalKegiatan}</td>
                            </tr>
                            <tr>
                                <td style="padding: 3px 0; font-weight: 500;">Waktu</td>
                                <td style="padding: 3px 0;">:</td>
                                <td style="padding: 3px 0;">${waktuKegiatan}</td>
                            </tr>
                            <tr>
                                <td style="padding: 3px 0; font-weight: 500;">Kegiatan</td>
                                <td style="padding: 3px 0;">:</td>
                                <td style="padding: 3px 0;">${kegiatan.nama}</td>
                            </tr>
                            <tr>
                                <td style="padding: 3px 0; font-weight: 500;">Penanggung Jawab</td>
                                <td style="padding: 3px 0;">:</td>
                                <td style="padding: 3px 0;">${kegiatan.penanggungJawab}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Attendance Table -->
                    <div style="margin-bottom: 25px;">
                        <table style="width: 100%; border-collapse: collapse; border: 2px solid #000;">
                            <thead>
                                <tr style="background-color: #f0f0f0;">
                                    ${headers.map(header => `
                                        <th style="border: 1px solid #000; padding: 12px 8px; text-align: center; font-weight: bold; font-size: ${fontSize.header};">${header}</th>
                                    `).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Notes -->
                    ${daftarHadirData.catatan ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="font-size: ${fontSize.header}; font-weight: bold; margin-bottom: 10px;">Catatan:</h4>
                        <p style="font-size: ${fontSize.content}; line-height: 1.5; background-color: #f9f9f9; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">${daftarHadirData.catatan}</p>
                    </div>
                    ` : ''}
                    
                    <!-- Footer Info -->
                    <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 50px;">
                        <div style="text-align: center;">
                            <p style="margin-bottom: 60px; font-size: ${fontSize.content};">Mengetahui,</p>
                            <div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div>
                            <p style="font-weight: 500; font-size: ${fontSize.content};">${kegiatan.penanggungJawab}</p>
                            <p style="font-size: ${fontSize.content}; color: #666;">Penanggung Jawab</p>
                        </div>
                        <div style="text-align: center;">
                            <p style="margin-bottom: 60px; font-size: ${fontSize.content};">Panitia Kegiatan,</p>
                            <div style="border-bottom: 1px solid #000; margin-bottom: 5px;"></div>
                            <p style="font-weight: 500; font-size: ${fontSize.content};">(...........................)</p>
                            <p style="font-size: ${fontSize.content}; color: #666;">Koordinator Panitia</p>
                        </div>
                    </div>
                    
                    <!-- Document Footer -->
                    <div style="text-align: center; margin-top: 25px; font-size: 10px; color: #666; border-top: 1px solid #ddd; padding-top: 10px;">
                        <p>Dibuat pada: ${new Date(daftarHadirData.createdAt).toLocaleString('id-ID')}</p>
                        <p>ID Dokumen: ${daftarHadirData.id} | Format: ${daftarHadirData.format.toUpperCase()}</p>
                        ${daftarHadirData.pesertaData && daftarHadirData.pesertaData.length > 0 ? 
                            `<p>Peserta Terdaftar: ${daftarHadirData.pesertaData.length} orang</p>` : 
                            '<p>Template kosong - dapat diisi manual</p>'
                        }
                    </div>
                </div>
            `;
        }
        
        // Simpan Daftar Hadir Langsung (dari header button)
        function simpanDaftarHadirLangsung() {
            if (!currentDraftDaftarHadir || !currentDraftKegiatan) {
                showNotification('âš ï¸ Tidak ada daftar hadir yang sedang dibuat!', 'warning');
                return;
            }
            
            // Show loading state
            const button = document.getElementById('simpan-daftar-hadir-btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i>Menyimpan...';
            button.disabled = true;
            
            try {
                // Save daftar hadir
                currentDraftDaftarHadir.status = 'Tersimpan';
                savedDaftarHadir.push(currentDraftDaftarHadir);
                
                // Update daftar hadir list
                updateDaftarHadirList();
                
                // Auto transfer to berita acara if has participants
                if (currentDraftDaftarHadir.pesertaData && currentDraftDaftarHadir.pesertaData.length > 0) {
                    // Switch to berita acara section
                    setTimeout(() => {
                        document.getElementById('menu-berita-acara').click();
                        
                        // Show berita acara modal with participants
                        setTimeout(() => {
                            showBeritaAcaraModalWithParticipants(currentDraftDaftarHadir);
                        }, 500);
                    }, 1000);
                    
                    showNotification(`âœ… Daftar hadir disimpan! Membuka berita acara dengan ${currentDraftDaftarHadir.pesertaData.length} peserta...`, 'success');
                } else {
                    showNotification(`âœ… Daftar hadir "${currentDraftKegiatan.nama}" berhasil disimpan!`, 'success');
                }
                
                // Clear draft
                currentDraftDaftarHadir = null;
                currentDraftKegiatan = null;
                
                // Hide save button
                button.classList.add('hidden');
                
            } catch (error) {
                console.error('Error saving daftar hadir:', error);
                showNotification('âŒ Gagal menyimpan daftar hadir!', 'error');
            } finally {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
                lucide.createIcons();
            }
        }
        
        // Show Daftar Hadir Preview
        function showDaftarHadirPreview(content, kegiatan, daftarHadirData) {
            const previewModal = document.createElement('div');
            previewModal.id = 'daftar-hadir-preview';
            previewModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            previewModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                    <!-- Header -->
                    <div class="gradient-bg p-4 text-white rounded-t-xl flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-bold">Preview Daftar Hadir</h3>
                            <p class="text-sm opacity-90">${kegiatan.nama} - Format: ${daftarHadirData.format.toUpperCase()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="printDaftarHadir()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                Print
                            </button>
                            <button onclick="downloadDaftarHadirPDF('${daftarHadirData.id}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Download
                            </button>
                            <button onclick="closeDaftarHadirPreview()" class="text-white hover:text-gray-200 transition-colors p-2">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                        <div id="daftar-hadir-content" class="bg-white p-8 rounded-lg shadow-sm mx-auto" style="${daftarHadirData.orientasi === 'landscape' ? 'max-width: 1200px;' : 'max-width: 800px;'}">
                            ${content}
                        </div>
                    </div>
                    
                    <!-- Footer Actions -->
                    <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                        <button onclick="saveDaftarHadir('${JSON.stringify(daftarHadirData).replace(/'/g, "\\'")}', '${JSON.stringify(kegiatan).replace(/'/g, "\\'")}', '${content.replace(/'/g, "\\'")}', '${daftarHadirData.id}')" class="btn-success text-white px-4 py-2 rounded-lg font-medium text-sm">
                            <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                            Simpan Daftar Hadir
                        </button>
                        ${daftarHadirData.pesertaData && daftarHadirData.pesertaData.length > 0 ? `
                        <button onclick="transferToBeritaAcara('${daftarHadirData.id}')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                            <i data-lucide="arrow-right" class="w-4 h-4 inline mr-2"></i>
                            Transfer ke Berita Acara
                        </button>
                        ` : ''}
                        <button onclick="editDaftarHadir('${daftarHadirData.id}')" class="btn-warning text-white px-4 py-2 rounded-lg font-medium text-sm">
                            <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                            Edit Format
                        </button>
                        <button onclick="closeDaftarHadirPreview()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                            <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(previewModal);
            lucide.createIcons();
        }
        
        // Close Daftar Hadir Preview
        function closeDaftarHadirPreview() {
            const modal = document.getElementById('daftar-hadir-preview');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        // Kirim Daftar Hadir ke Google Sheets
        async function kirimDaftarHadirKeGoogleSheets(daftarHadirData) {
            const scriptUrl = document.getElementById('script-url').value;
            
            if (!scriptUrl) {
                console.log('Script URL belum diatur');
                return false;
            }
            
            try {
                const payload = {
                    action: 'CREATE_DAFTAR_HADIR',
                    data: {
                        id: daftarHadirData.id,
                        kegiatan_id: daftarHadirData.kegiatanId,
                        nama_kegiatan: daftarHadirData.namaKegiatan,
                        format: daftarHadirData.format,
                        jumlah_baris: daftarHadirData.jumlahBaris,
                        orientasi: daftarHadirData.orientasi,
                        ukuran_font: daftarHadirData.ukuranFont,
                        catatan: daftarHadirData.catatan,
                        jumlah_peserta: daftarHadirData.pesertaData ? daftarHadirData.pesertaData.length : 0,
                        status: daftarHadirData.status,
                        created_at: daftarHadirData.createdAt,
                        peserta_data: daftarHadirData.pesertaData || []
                    }
                };
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                return true; // Assume success for no-cors
                
            } catch (error) {
                console.error('Error sending daftar hadir to sheets:', error);
                return false;
            }
        }
        
        // Save Daftar Hadir
        function saveDaftarHadir(daftarHadirDataStr, kegiatanStr, content, id) {
            try {
                const daftarHadirData = JSON.parse(daftarHadirDataStr);
                const kegiatan = JSON.parse(kegiatanStr);
                
                // Add to saved daftar hadir
                daftarHadirData.content = content;
                daftarHadirData.status = 'Tersimpan';
                savedDaftarHadir.push(daftarHadirData);
                
                // Update daftar hadir list
                updateDaftarHadirList();
                
                // Send to Google Sheets
                setTimeout(async () => {
                    try {
                        const success = await kirimDaftarHadirKeGoogleSheets(daftarHadirData);
                        
                        if (success) {
                            showNotification(`âœ… Daftar hadir "${kegiatan.nama}" berhasil disimpan dan dikirim ke Google Sheets!`, 'success');
                        } else {
                            showNotification(`âš ï¸ Daftar hadir disimpan lokal. Gagal mengirim ke Google Sheets.`, 'warning');
                        }
                    } catch (error) {
                        console.error('Error sending daftar hadir to sheets:', error);
                        showNotification(`âš ï¸ Daftar hadir disimpan lokal. Error: ${error.message}`, 'warning');
                    }
                }, 1000);
                
                // Close preview
                closeDaftarHadirPreview();
                
            } catch (error) {
                console.error('Error saving daftar hadir:', error);
                showNotification('Gagal menyimpan daftar hadir!', 'error');
            }
        }
        
        // Print Daftar Hadir
        function printDaftarHadir() {
            const content = document.getElementById('daftar-hadir-content').innerHTML;
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daftar Hadir Kegiatan</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 15px; line-height: 1.4; }
                        .print-header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; }
                        td, th { padding: 8px; border: 1px solid #000; }
                        th { background-color: #f0f0f0; font-weight: bold; text-align: center; }
                        .grid { display: grid; }
                        .grid-cols-2 { grid-template-columns: 1fr 1fr; }
                        .gap-8 { gap: 2rem; }
                        .text-center { text-align: center; }
                        .border-b { border-bottom: 1px solid #000; }
                        .mb-16 { margin-bottom: 4rem; }
                        .mb-2 { margin-bottom: 0.5rem; }
                        .font-medium { font-weight: 500; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
            
            showNotification('Daftar hadir siap untuk dicetak!', 'success');
        }
        
        // Download Daftar Hadir PDF
        function downloadDaftarHadirPDF(id) {
            showNotification('Fitur download PDF akan segera tersedia!', 'info');
        }
        
        // Update Daftar Hadir List
        function updateDaftarHadirList() {
            const container = document.getElementById('daftar-hadir-list');
            
            if (savedDaftarHadir.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="users" class="w-20 h-20 text-gray-300 mx-auto mb-4"></i>
                        <h4 class="text-lg font-semibold text-gray-600 mb-2">Belum Ada Template Daftar Hadir</h4>
                        <p class="text-gray-500 mb-4">Generate template daftar hadir untuk kegiatan yang akan dilaksanakan</p>
                        <button onclick="generateDaftarHadir()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                            <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i>
                            Generate Daftar Hadir
                        </button>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = savedDaftarHadir.map(dh => {
                const kegiatan = kegiatanData.find(k => k.id === dh.kegiatanId);
                const statusColor = {
                    'Draft': 'bg-yellow-100 text-yellow-800',
                    'Tersimpan': 'bg-green-100 text-green-800',
                    'Digunakan': 'bg-blue-100 text-blue-800'
                }[dh.status] || 'bg-gray-100 text-gray-800';
                
                const formatLabels = {
                    'standard': 'Standard',
                    'lengkap': 'Lengkap',
                    'siswa': 'Siswa',
                    'guru': 'Guru'
                };
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-shadow">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h4 class="text-lg font-semibold text-gray-800 mb-2">${dh.namaKegiatan}</h4>
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="px-3 py-1 ${statusColor} rounded-full text-sm font-medium">${dh.status}</span>
                                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">${formatLabels[dh.format]}</span>
                                    <span class="text-sm text-gray-500">ID: ${dh.id}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 text-sm">
                            <div>
                                <span class="text-gray-500">Format:</span>
                                <p class="font-medium text-gray-700">${formatLabels[dh.format]}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Jumlah Baris:</span>
                                <p class="font-medium text-gray-700">${dh.jumlahBaris} baris</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Orientasi:</span>
                                <p class="font-medium text-gray-700">${dh.orientasi === 'portrait' ? 'Portrait' : 'Landscape'}</p>
                            </div>
                            <div>
                                <span class="text-gray-500">Dibuat:</span>
                                <p class="font-medium text-gray-700">${new Date(dh.createdAt).toLocaleDateString('id-ID')}</p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                            <button onclick="previewDaftarHadir('${dh.id}')" class="btn-primary text-white px-4 py-2 rounded-lg font-medium text-sm">
                                <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                                Preview
                            </button>
                            <button onclick="printSavedDaftarHadir('${dh.id}')" class="btn-success text-white px-4 py-2 rounded-lg font-medium text-sm">
                                <i data-lucide="printer" class="w-4 h-4 inline mr-2"></i>
                                Print
                            </button>
                            <button onclick="editDaftarHadir('${dh.id}')" class="btn-warning text-white px-4 py-2 rounded-lg font-medium text-sm">
                                <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                                Edit
                            </button>
                            <button onclick="hapusDaftarHadir('${dh.id}')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium text-sm transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                                Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }
        
        // Preview Saved Daftar Hadir
        function previewDaftarHadir(id) {
            const dh = savedDaftarHadir.find(d => d.id === id);
            if (!dh) {
                showNotification('Daftar hadir tidak ditemukan!', 'error');
                return;
            }
            
            const kegiatan = kegiatanData.find(k => k.id === dh.kegiatanId);
            showDaftarHadirPreview(dh.content, kegiatan, dh);
        }
        
        // Print Saved Daftar Hadir
        function printSavedDaftarHadir(id) {
            const dh = savedDaftarHadir.find(d => d.id === id);
            if (!dh) {
                showNotification('Daftar hadir tidak ditemukan!', 'error');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Daftar Hadir - ${dh.namaKegiatan}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 15px; line-height: 1.4; }
                        .print-header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; }
                        td, th { padding: 8px; border: 1px solid #000; }
                        th { background-color: #f0f0f0; font-weight: bold; text-align: center; }
                        .grid { display: grid; }
                        .grid-cols-2 { grid-template-columns: 1fr 1fr; }
                        .gap-8 { gap: 2rem; }
                        .text-center { text-align: center; }
                        .border-b { border-bottom: 1px solid #000; }
                        .mb-16 { margin-bottom: 4rem; }
                        .mb-2 { margin-bottom: 0.5rem; }
                        .font-medium { font-weight: 500; }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                            @page { size: ${dh.orientasi}; margin: 1cm; }
                        }
                    </style>
                </head>
                <body>
                    ${dh.content}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
            
            showNotification(`Daftar Hadir "${dh.namaKegiatan}" siap untuk dicetak!`, 'success');
        }
        
        // Edit Daftar Hadir
        function editDaftarHadir(id) {
            showNotification(`Edit daftar hadir dengan ID: ${id}`, 'info');
        }
        
        // Hapus Daftar Hadir
        function hapusDaftarHadir(id) {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            confirmModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="text-center">
                        <i data-lucide="trash-2" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Hapus Daftar Hadir</h3>
                        <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus template daftar hadir ini?</p>
                        
                        <div class="flex space-x-4">
                            <button onclick="confirmHapusDaftarHadir('${id}'); this.parentElement.parentElement.parentElement.parentElement.remove();" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Ya, Hapus
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove();" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            lucide.createIcons();
        }
        
        function confirmHapusDaftarHadir(id) {
            const index = savedDaftarHadir.findIndex(dh => dh.id === id);
            if (index !== -1) {
                savedDaftarHadir.splice(index, 1);
                updateDaftarHadirList();
                showNotification(`Template daftar hadir berhasil dihapus!`, 'success');
            }
        }
        
        // Download All Daftar Hadir
        function downloadAllDaftarHadir() {
            if (savedDaftarHadir.length === 0) {
                showNotification('Belum ada template daftar hadir untuk diunduh!', 'warning');
                return;
            }
            
            showNotification(`Mengunduh ${savedDaftarHadir.length} template daftar hadir...`, 'info');
            
            // Create ZIP-like structure (simplified)
            setTimeout(() => {
                showNotification('Semua template daftar hadir berhasil diunduh!', 'success');
            }, 2000);
        }
        
        // Filter Daftar Hadir
        function filterDaftarHadir() {
            // Implementation for filtering daftar hadir
            console.log('Filter daftar hadir');
        }
        
        // Transfer peserta dari daftar hadir ke berita acara
        function transferToBeritaAcara(daftarHadirId) {
            const daftarHadir = savedDaftarHadir.find(dh => dh.id === daftarHadirId);
            if (!daftarHadir) {
                showNotification('âŒ Daftar hadir tidak ditemukan!', 'error');
                return;
            }
            
            if (!daftarHadir.pesertaData || daftarHadir.pesertaData.length === 0) {
                showNotification('âš ï¸ Tidak ada data peserta untuk ditransfer!', 'warning');
                return;
            }
            
            // Close current preview
            closeDaftarHadirPreview();
            
            // Switch to berita acara section
            document.getElementById('menu-berita-acara').click();
            
            // Wait for section to load then show modal with pre-filled data
            setTimeout(() => {
                showBeritaAcaraModalWithParticipants(daftarHadir);
            }, 500);
        }
        
        // Show berita acara modal with participants from daftar hadir
        function showBeritaAcaraModalWithParticipants(daftarHadir) {
            const kegiatan = kegiatanData.find(k => k.id === daftarHadir.kegiatanId);
            if (!kegiatan) {
                showNotification('âŒ Data kegiatan tidak ditemukan!', 'error');
                return;
            }
            
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'berita-acara-modal';
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            // Generate participant list for display
            const participantList = daftarHadir.pesertaData.map((peserta, index) => {
                let info = `${index + 1}. ${peserta.nama}`;
                if (peserta.jabatan) info += ` (${peserta.jabatan})`;
                if (peserta.nip) info += ` - NIP: ${peserta.nip}`;
                if (peserta.mapel) info += ` - ${peserta.mapel}`;
                if (peserta.kelas) info += ` - ${peserta.kelas}`;
                if (peserta.instansi) info += ` - ${peserta.instansi}`;
                return info;
            }).join('\n');
            
            modalOverlay.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="gradient-bg p-6 text-white rounded-t-xl">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-xl font-bold">Generate Berita Acara</h3>
                                <p class="text-sm opacity-90">Data peserta dari Daftar Hadir: ${daftarHadir.id}</p>
                            </div>
                            <button onclick="closeBeritaAcaraModal()" class="text-white hover:text-gray-200 transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Info Transfer -->
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                            <div class="flex items-center">
                                <i data-lucide="info" class="w-5 h-5 text-blue-600 mr-2"></i>
                                <h4 class="font-semibold text-blue-800">Data Peserta Ditransfer</h4>
                            </div>
                            <p class="text-blue-700 text-sm mt-1">
                                ${daftarHadir.pesertaData.length} peserta dari daftar hadir "${daftarHadir.namaKegiatan}" telah ditransfer ke berita acara ini.
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Kegiatan (Otomatis Dipilih)</label>
                            <select id="select-kegiatan-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none bg-gray-100" disabled>
                                <option value="${kegiatan.id}" selected>${kegiatan.nama} - ${formatTanggal(kegiatan.tanggalMulai)}</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tempat Kegiatan</label>
                                <input type="text" id="tempat-kegiatan-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Contoh: Aula Sekolah" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pimpinan Rapat</label>
                                <input type="text" id="pimpinan-rapat-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Contoh: Kepala Sekolah" value="${kegiatan.penanggungJawab}" required>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Agenda Pembahasan</label>
                            <textarea id="agenda-pembahasan-ba" rows="4" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none" placeholder="Masukkan agenda pembahasan kegiatan..."></textarea>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hasil Keputusan</label>
                            <textarea id="hasil-keputusan-ba" rows="4" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none" placeholder="Masukkan hasil keputusan atau kesimpulan..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notulen Rapat</label>
                                <input type="text" id="notulen-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Nama notulen rapat">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Moderator</label>
                                <input type="text" id="moderator-ba" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none" placeholder="Nama moderator">
                            </div>
                        </div>
                        
                        <!-- Daftar Peserta -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Daftar Peserta (${daftarHadir.pesertaData.length} orang)</label>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 max-h-48 overflow-y-auto">
                                <pre class="text-sm text-gray-700 whitespace-pre-wrap">${participantList}</pre>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Data peserta akan otomatis disertakan dalam berita acara</p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Tambahan</label>
                            <textarea id="catatan-tambahan-ba" rows="3" class="form-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none resize-none" placeholder="Catatan atau informasi tambahan..."></textarea>
                        </div>
                        
                        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
                            <button onclick="createBeritaAcaraWithParticipants('${daftarHadir.id}')" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                                <i data-lucide="file-plus" class="w-4 h-4 inline mr-2"></i>
                                Buat Berita Acara dengan Peserta
                            </button>
                            <button onclick="closeBeritaAcaraModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                                <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modalOverlay);
            lucide.createIcons();
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeBeritaAcaraModal();
                }
            });
            
            showNotification(`âœ… Data ${daftarHadir.pesertaData.length} peserta berhasil ditransfer ke berita acara!`, 'success');
        }
        
        // Create berita acara with participants from daftar hadir
        function createBeritaAcaraWithParticipants(daftarHadirId) {
            const daftarHadir = savedDaftarHadir.find(dh => dh.id === daftarHadirId);
            if (!daftarHadir) {
                showNotification('âŒ Data daftar hadir tidak ditemukan!', 'error');
                return;
            }
            
            const kegiatanId = daftarHadir.kegiatanId;
            const tempatKegiatan = document.getElementById('tempat-kegiatan-ba').value;
            const pimpinanRapat = document.getElementById('pimpinan-rapat-ba').value;
            const agendaPembahasan = document.getElementById('agenda-pembahasan-ba').value;
            const hasilKeputusan = document.getElementById('hasil-keputusan-ba').value;
            const notulen = document.getElementById('notulen-ba').value;
            const moderator = document.getElementById('moderator-ba').value;
            const catatanTambahan = document.getElementById('catatan-tambahan-ba').value;
            
            if (!tempatKegiatan || !pimpinanRapat) {
                showNotification('Mohon lengkapi semua field yang wajib diisi!', 'warning');
                return;
            }
            
            const kegiatan = kegiatanData.find(k => k.id === kegiatanId);
            if (!kegiatan) {
                showNotification('Kegiatan tidak ditemukan!', 'error');
                return;
            }
            
            // Create berita acara data object with participants
            const beritaAcaraData = {
                id: 'BA' + Date.now(),
                kegiatanId: kegiatanId,
                namaKegiatan: kegiatan.nama,
                tempatKegiatan: tempatKegiatan,
                pimpinanRapat: pimpinanRapat,
                agendaPembahasan: agendaPembahasan,
                hasilKeputusan: hasilKeputusan,
                notulen: notulen,
                moderator: moderator,
                catatanTambahan: catatanTambahan,
                pesertaData: daftarHadir.pesertaData, // Include participant data
                daftarHadirId: daftarHadirId, // Reference to source daftar hadir
                createdAt: new Date().toISOString(),
                status: 'Draft'
            };
            
            // Generate berita acara content with participants
            const beritaAcaraContent = generateBeritaAcaraContentWithParticipants(kegiatan, beritaAcaraData);
            
            // Store as current draft
            currentDraftBeritaAcara = beritaAcaraData;
            currentDraftBeritaAcaraKegiatan = kegiatan;
            
            // Show save button in header
            const saveButton = document.getElementById('simpan-berita-acara-btn');
            if (saveButton) {
                saveButton.classList.remove('hidden');
            }
            
            // Show preview modal with save option
            showBeritaAcaraPreview(beritaAcaraContent, kegiatan, beritaAcaraData);
            closeBeritaAcaraModal();
        }

        // ===== PENGATURAN FUNCTIONS =====
        
        // Test Connection
        function testConnection() {
            console.log('Test connection clicked');
            
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i>Testing...';
            button.disabled = true;
            
            showNotification('ðŸ”„ Menguji koneksi ke Google Sheets...', 'info');
            
            setTimeout(async () => {
                try {
                    // Try to read data from Google Sheets
                    const success = await bacaDataDariGoogleSheets(true);
                    
                    if (success) {
                        showNotification('âœ… Koneksi berhasil! Google Sheets dapat diakses.', 'success');
                    } else {
                        showNotification('âš ï¸ Koneksi terhubung tapi tidak ada data atau format tidak sesuai.', 'warning');
                    }
                } catch (error) {
                    console.error('Connection test error:', error);
                    showNotification('âŒ Koneksi gagal! Periksa URL Apps Script.', 'error');
                } finally {
                    // Restore button state
                    button.innerHTML = originalText;
                    button.disabled = false;
                    lucide.createIcons();
                }
            }, 2000);
        }
        
        // Save Settings
        function saveSettings() {
            console.log('Save settings clicked');
            
            const spreadsheetId = document.getElementById('spreadsheet-id').value;
            const sheetName = document.getElementById('sheet-name').value;
            const scriptUrl = document.getElementById('script-url').value;
            
            // Simulate saving settings
            showNotification('âš™ï¸ Menyimpan pengaturan...', 'info');
            
            setTimeout(() => {
                showNotification('âœ… Pengaturan berhasil disimpan!', 'success');
            }, 1000);
        }
        
        // Test Script
        function testScript() {
            console.log('Test script clicked');
            
            const scriptUrl = document.getElementById('script-url').value;
            
            if (!scriptUrl) {
                showNotification('âš ï¸ Mohon masukkan Script URL terlebih dahulu!', 'warning');
                return;
            }
            
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i>Testing...';
            button.disabled = true;
            
            showNotification('ðŸ§ª Menguji Apps Script...', 'info');
            
            setTimeout(async () => {
                try {
                    // Test script functionality
                    const testData = {
                        action: 'CREATE',
                        data: {
                            id: 'TEST' + Date.now(),
                            nama_kegiatan: 'Test Kegiatan',
                            jenis_kegiatan: 'Test',
                            kategori_kegiatan: 'Test',
                            tanggal_mulai: new Date().toISOString().split('T')[0],
                            tanggal_selesai: new Date().toISOString().split('T')[0],
                            waktu_mulai: '08:00',
                            waktu_selesai: '10:00',
                            status: 'Test',
                            penanggung_jawab: 'Test User',
                            jumlah_peserta: 1,
                            deskripsi: 'Test deskripsi',
                            dokumentasi: '',
                            created_at: new Date().toISOString()
                        }
                    };
                    
                    const response = await fetch(scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(testData)
                    });
                    
                    // For no-cors, we can't read response but assume success if no error
                    showNotification('âœ… Apps Script berfungsi! Test data berhasil dikirim.', 'success');
                    
                } catch (error) {
                    console.error('Script test error:', error);
                    
                    // For CORS errors, still consider it success
                    if (error.message.includes('CORS') || error.name === 'TypeError') {
                        showNotification('âš ï¸ Script berfungsi! (CORS normal untuk Apps Script)', 'warning');
                    } else {
                        showNotification('âŒ Script error: ' + error.message, 'error');
                    }
                } finally {
                    // Restore button state
                    button.innerHTML = originalText;
                    button.disabled = false;
                    lucide.createIcons();
                }
            }, 2000);
        }
        
        // Kirim Data Manual
        function kirimDataManual() {
            console.log('Kirim data manual clicked');
            
            if (kegiatanData.length === 0) {
                showNotification('âš ï¸ Tidak ada data kegiatan untuk dikirim!', 'warning');
                return;
            }
            
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 inline mr-2 animate-spin"></i>Mengirim...';
            button.disabled = true;
            
            showNotification(`ðŸ“¤ Mengirim ${kegiatanData.length} data kegiatan ke Google Sheets...`, 'info');
            
            // Send all data
            let successCount = 0;
            let errorCount = 0;
            
            const sendPromises = kegiatanData.map(async (kegiatan) => {
                try {
                    const success = await kirimKeGoogleSheets(kegiatan);
                    if (success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            });
            
            Promise.all(sendPromises).then(() => {
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
                lucide.createIcons();
                
                if (successCount > 0) {
                    showNotification(`âœ… ${successCount} data berhasil dikirim ke Google Sheets!`, 'success');
                }
                
                if (errorCount > 0) {
                    showNotification(`âš ï¸ ${errorCount} data gagal dikirim.`, 'warning');
                }
            });
        }
        
        // Reset Settings
        function resetSettings() {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            
            confirmModal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="text-center">
                        <i data-lucide="rotate-ccw" class="w-16 h-16 text-orange-500 mx-auto mb-4"></i>
                        <h3 class="text-lg font-bold text-gray-800 mb-2">Reset Pengaturan</h3>
                        <p class="text-gray-600 mb-6">Apakah Anda yakin ingin mereset semua pengaturan ke default?</p>
                        
                        <div class="flex space-x-4">
                            <button onclick="confirmResetSettings(); this.parentElement.parentElement.parentElement.parentElement.remove();" 
                                    class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Ya, Reset
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove();" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                Batal
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            lucide.createIcons();
        }
        
        function confirmResetSettings() {
            // Reset to default values
            document.getElementById('sync-interval').value = 30;
            document.getElementById('auto-sync-toggle').checked = true;
            document.getElementById('sync-notifications').checked = true;
            
            // Reset sync settings
            syncIntervalSeconds = 30;
            autoSyncEnabled = true;
            
            // Restart auto-sync
            stopAutoSync();
            startAutoSync();
            
            // Update UI
            updateAutoSyncIndicator('active');
            
            showNotification('âš™ï¸ Pengaturan berhasil direset ke default!', 'success');
        }
        
        // Create Backup
        function createBackup() {
            console.log('Create backup clicked');
            
            const backupData = {
                kegiatanData: kegiatanData,
                savedBeritaAcara: savedBeritaAcara,
                savedDaftarHadir: savedDaftarHadir,
                settings: {
                    autoSyncEnabled: autoSyncEnabled,
                    syncIntervalSeconds: syncIntervalSeconds
                },
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            
            // Create and download backup file
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `backup_sistem_kegiatan_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('ðŸ’¾ Backup berhasil dibuat dan diunduh!', 'success');
        }
        
        // Restore Backup
        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Validate backup data
                        if (!backupData.kegiatanData || !Array.isArray(backupData.kegiatanData)) {
                            throw new Error('Format backup tidak valid');
                        }
                        
                        // Restore data
                        kegiatanData = backupData.kegiatanData || [];
                        savedBeritaAcara = backupData.savedBeritaAcara || [];
                        savedDaftarHadir = backupData.savedDaftarHadir || [];
                        
                        // Restore settings if available
                        if (backupData.settings) {
                            autoSyncEnabled = backupData.settings.autoSyncEnabled !== undefined ? backupData.settings.autoSyncEnabled : true;
                            syncIntervalSeconds = backupData.settings.syncIntervalSeconds || 30;
                            
                            // Update UI
                            document.getElementById('auto-sync-toggle').checked = autoSyncEnabled;
                            document.getElementById('sync-interval').value = syncIntervalSeconds;
                        }
                        
                        // Update all UI components
                        updateDashboard();
                        updateAgendaList();
                        updateRekapData();
                        updateBeritaAcaraList();
                        updateDaftarHadirList();
                        updateBeritaAcaraFilters();
                        updateDaftarHadirFilters();
                        
                        // Restart auto-sync if enabled
                        if (autoSyncEnabled) {
                            stopAutoSync();
                            startAutoSync();
                        }
                        
                        showNotification(`âœ… Backup berhasil dipulihkan! ${kegiatanData.length} kegiatan dimuat.`, 'success');
                        
                    } catch (error) {
                        console.error('Restore backup error:', error);
                        showNotification('âŒ Gagal memulihkan backup: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        // Copy to Clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('ðŸ“‹ Kode berhasil disalin ke clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showNotification('âŒ Gagal menyalin kode', 'error');
            });
        }

        // ===== UTILITY FUNCTIONS =====
        
        // Format Tanggal
        function formatTanggal(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                return date.toLocaleDateString('id-ID', options);
            } catch (error) {
                return dateString;
            }
        }
        
        // Format Waktu
        function formatWaktu(timeString) {
            if (!timeString) return '-';
            return timeString + ' WIB';
        }
        
        // Generate Random ID
        function generateId(prefix = 'ID') {
            return prefix + Date.now() + Math.random().toString(36).substr(2, 5);
        }
        
        // Validate Email
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        // Validate Phone
        function validatePhone(phone) {
            const re = /^[\+]?[0-9\-\(\)\s]+$/;
            return re.test(phone);
        }
        
        // Sanitize HTML
        function sanitizeHtml(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }
        
        // Debounce Function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Throttle Function
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }

        // ===== INITIALIZATION =====
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸš€ Sistem Kegiatan Sekolah - Initializing...');
            
            // Initialize Lucide icons
            lucide.createIcons();
            
            // Set default date values
            const today = new Date().toISOString().split('T')[0];
            const tanggalMulaiInput = document.getElementById('tanggal-mulai');
            const tanggalSelesaiInput = document.getElementById('tanggal-selesai');
            
            if (tanggalMulaiInput) tanggalMulaiInput.value = today;
            if (tanggalSelesaiInput) tanggalSelesaiInput.value = today;
            
            // Initialize dashboard
            updateDashboard();
            updateAgendaList();
            updateRekapData();
            updateBeritaAcaraList();
            updateDaftarHadirList();
            
            // Start auto-sync if enabled
            if (autoSyncEnabled) {
                setTimeout(() => {
                    startAutoSync();
                    console.log('âœ… Auto-sync initialized');
                }, 2000);
            }
            
            // Show welcome notification
            setTimeout(() => {
                showNotification('ðŸŽ‰ Sistem Kegiatan Sekolah siap digunakan!', 'success');
            }, 1000);
            
            console.log('âœ… Sistem Kegiatan Sekolah - Initialized successfully');
        });
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            // Stop auto-sync
            stopAutoSync();
            console.log('ðŸ‘‹ Sistem Kegiatan Sekolah - Shutting down...');
        });
        
        // Handle errors
        window.addEventListener('error', function(event) {
            console.error('âŒ Global error:', event.error);
            showNotification('âš ï¸ Terjadi kesalahan sistem. Silakan refresh halaman.', 'error');
        });
        
        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('âŒ Unhandled promise rejection:', event.reason);
            showNotification('âš ï¸ Terjadi kesalahan jaringan. Periksa koneksi internet.', 'warning');
        });

        console.log('ðŸ“š Sistem Kegiatan Sekolah v1.0 - Ready');
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'998b3dc10510008f',t:'MTc2MjE2NjI5OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>